from code_indexer.server.middleware.correlation import get_correlation_id
"""ChangeDetector - git change detection for auto-update service."""

from pathlib import Path
import subprocess
import logging

logger = logging.getLogger(__name__)


class ChangeDetector:
    """Detects changes in git repository by comparing local and remote refs."""

    def __init__(self, repo_path: Path, branch: str = "master"):
        """Initialize ChangeDetector.

        Args:
            repo_path: Path to git repository
            branch: Branch name to track (default: master)
        """
        self.repo_path = repo_path
        self.branch = branch

    def fetch(self) -> None:
        """Fetch latest changes from remote repository.

        Raises:
            subprocess.CalledProcessError: If git fetch fails
        """
        result = subprocess.run(
            ["git", "fetch", "origin", self.branch, "--quiet"],
            cwd=self.repo_path,
            capture_output=True,
            text=True,
        )

        if result.returncode != 0:
            logger.error(f"Git fetch failed: {result.stderr}", extra={"correlation_id": get_correlation_id()})
            raise subprocess.CalledProcessError(
                result.returncode,
                result.args,
                result.stdout,
                result.stderr,
            )

        logger.debug("Git fetch completed successfully", extra={"correlation_id": get_correlation_id()})

    def get_local_ref(self) -> str:
        """Get current local HEAD ref.

        Returns:
            Commit hash of local HEAD

        Raises:
            subprocess.CalledProcessError: If git rev-parse fails
        """
        result = subprocess.run(
            ["git", "rev-parse", "HEAD"],
            cwd=self.repo_path,
            capture_output=True,
            text=True,
        )

        if result.returncode != 0:
            logger.error(f"Git rev-parse HEAD failed: {result.stderr}", extra={"correlation_id": get_correlation_id()})
            raise subprocess.CalledProcessError(
                result.returncode,
                result.args,
                result.stdout,
                result.stderr,
            )

        local_ref = result.stdout.strip()
        logger.debug(f"Local ref: {local_ref}", extra={"correlation_id": get_correlation_id()})
        return local_ref

    def get_remote_ref(self) -> str:
        """Get remote branch ref.

        Returns:
            Commit hash of remote branch

        Raises:
            subprocess.CalledProcessError: If git rev-parse fails
        """
        result = subprocess.run(
            ["git", "rev-parse", f"origin/{self.branch}"],
            cwd=self.repo_path,
            capture_output=True,
            text=True,
        )

        if result.returncode != 0:
            logger.error(f"Git rev-parse origin/{self.branch} failed: {result.stderr}", extra={"correlation_id": get_correlation_id()})
            raise subprocess.CalledProcessError(
                result.returncode,
                result.args,
                result.stdout,
                result.stderr,
            )

        remote_ref = result.stdout.strip()
        logger.debug(f"Remote ref: {remote_ref}", extra={"correlation_id": get_correlation_id()})
        return remote_ref

    def has_changes(self) -> bool:
        """Check if remote has changes compared to local.

        Returns:
            True if remote has new commits, False otherwise

        Raises:
            subprocess.CalledProcessError: If git operations fail
        """
        # Fetch latest changes from remote
        self.fetch()

        # Get local and remote refs
        local_ref = self.get_local_ref()
        remote_ref = self.get_remote_ref()

        # Compare refs
        has_changes = local_ref != remote_ref

        if has_changes:
            logger.info(f"Changes detected: {local_ref} -> {remote_ref}", extra={"correlation_id": get_correlation_id()})
        else:
            logger.debug("No changes detected", extra={"correlation_id": get_correlation_id()})

        return has_changes
