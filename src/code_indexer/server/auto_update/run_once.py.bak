from code_indexer.server.middleware.correlation import get_correlation_id
#!/usr/bin/env python3
"""Auto-update service entry point - executes one polling iteration."""

import sys
import os
import logging
from pathlib import Path

from code_indexer.server.auto_update.service import AutoUpdateService
from code_indexer.server.auto_update.change_detector import ChangeDetector
from code_indexer.server.auto_update.deployment_lock import DeploymentLock
from code_indexer.server.auto_update.deployment_executor import DeploymentExecutor

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
)

logger = logging.getLogger(__name__)


def main():
    """Execute one auto-update polling iteration."""
    try:
        # Configuration
        repo_path = Path(
            os.environ.get("CIDX_SERVER_REPO_PATH", "/home/sebabattig/cidx-server")
        )
        lock_file = Path("/tmp/cidx-auto-update.lock")
        check_interval = 60  # seconds (not used in oneshot mode)

        # Initialize components
        change_detector = ChangeDetector(repo_path=repo_path, branch="master")
        deployment_lock = DeploymentLock(lock_file=lock_file)
        deployment_executor = DeploymentExecutor(
            repo_path=repo_path,
            service_name="cidx-server",
        )

        # Initialize service
        service = AutoUpdateService(
            repo_path=repo_path,
            check_interval=check_interval,
            lock_file=lock_file,
        )

        # Inject dependencies
        service.change_detector = change_detector
        service.deployment_lock = deployment_lock
        service.deployment_executor = deployment_executor

        # Execute one polling iteration
        logger.info("Starting auto-update polling iteration", extra={"correlation_id": get_correlation_id()})
        service.poll_once()
        logger.info("Auto-update polling iteration completed", extra={"correlation_id": get_correlation_id()})

        sys.exit(0)

    except Exception as e:
        logger.exception(f"Auto-update polling failed: {e}", extra={"correlation_id": get_correlation_id()})
        sys.exit(1)


if __name__ == "__main__":
    main()
