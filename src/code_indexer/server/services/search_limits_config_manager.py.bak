from code_indexer.server.middleware.correlation import get_correlation_id
"""
Search Limits Configuration Manager for database persistence.

Manages persistent storage of search timeout and size limit configuration.
"""

import logging
import sqlite3
import threading
from pathlib import Path
from typing import Optional

from ..models.search_limits_config import SearchLimitsConfig

logger = logging.getLogger(__name__)


class SearchLimitsConfigManager:
    """
    Manages persistent storage of search limits configuration.

    Features:
    - SQLite-based persistence
    - Thread-safe access
    - Singleton pattern for global config
    - Default configuration on first access
    """

    _instance = None
    _lock = threading.Lock()

    def __init__(self, db_path: Optional[str] = None):
        """
        Initialize search limits config manager.

        Args:
            db_path: Database path (defaults to ~/.cidx-server/search_config.db)
        """
        if db_path:
            self.db_path = Path(db_path)
        else:
            server_dir = Path.home() / ".cidx-server"
            server_dir.mkdir(parents=True, exist_ok=True)
            self.db_path = server_dir / "search_config.db"

        # Ensure database directory exists
        self.db_path.parent.mkdir(parents=True, exist_ok=True)

        # Initialize database
        self._init_database()

    def _init_database(self):
        """Initialize SQLite database for config storage."""
        with sqlite3.connect(self.db_path, timeout=30) as conn:
            conn.execute(
                """
                CREATE TABLE IF NOT EXISTS search_limits_config (
                    id INTEGER PRIMARY KEY CHECK (id = 1),
                    max_result_size_mb INTEGER NOT NULL DEFAULT 1,
                    timeout_seconds INTEGER NOT NULL DEFAULT 30,
                    updated_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
                )
            """
            )

            # Insert default config if not exists
            conn.execute(
                """
                INSERT OR IGNORE INTO search_limits_config (id, max_result_size_mb, timeout_seconds)
                VALUES (1, 1, 30)
            """
            )
            conn.commit()

        logger.info(f"Search limits config database initialized at {self.db_path}", extra={"correlation_id": get_correlation_id()})

    def get_config(self) -> SearchLimitsConfig:
        """
        Get current search limits configuration.

        Returns:
            SearchLimitsConfig instance
        """
        with self._lock:
            with sqlite3.connect(self.db_path, timeout=30) as conn:
                cursor = conn.execute(
                    """
                    SELECT max_result_size_mb, timeout_seconds
                    FROM search_limits_config
                    WHERE id = 1
                """
                )
                row = cursor.fetchone()

                if row:
                    return SearchLimitsConfig(
                        max_result_size_mb=row[0], timeout_seconds=row[1]
                    )
                else:
                    # Return default if somehow not found
                    logger.warning("Config not found in database, using defaults", extra={"correlation_id": get_correlation_id()})
                    return SearchLimitsConfig()

    def update_config(self, config: SearchLimitsConfig):
        """
        Update search limits configuration.

        Args:
            config: New configuration to persist
        """
        with self._lock:
            with sqlite3.connect(self.db_path, timeout=30) as conn:
                conn.execute(
                    """
                    UPDATE search_limits_config
                    SET max_result_size_mb = ?,
                        timeout_seconds = ?,
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = 1
                """,
                    (config.max_result_size_mb, config.timeout_seconds),
                )
                conn.commit()

        logger.info(
            f"Updated search limits config: {config.max_result_size_mb}MB, {config.timeout_seconds}s"
        )

    @classmethod
    def get_instance(cls, db_path: Optional[str] = None) -> "SearchLimitsConfigManager":
        """
        Get singleton instance of config manager.

        Args:
            db_path: Database path (only used on first call)

        Returns:
            SearchLimitsConfigManager instance
        """
        if cls._instance is None:
            with cls._lock:
                if cls._instance is None:
                    cls._instance = cls(db_path)
        return cls._instance
