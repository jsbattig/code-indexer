<h2>Golden Repositories</h2>

<table class="golden-repos-table" role="grid">
    <thead>
        <tr>
            <th>Name</th>
            <th>Global Alias</th>
            <th>Version</th>
            <th>Indexes</th>
            <th>Path/URL</th>
            <th style="min-width: 100px;">Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% if repos %}
        {% for repo in repos %}
        <tr>
            <td>{{ repo.alias }}</td>
            <td>
                {% if repo.global_alias %}
                <code class="global-alias">{{ repo.global_alias }}</code>
                {% else %}
                <span class="no-global">-</span>
                {% endif %}
            </td>
            <td>
                {% if repo.version %}
                <code class="version-tag">{{ repo.version }}</code>
                {% else %}
                <span class="no-version">-</span>
                {% endif %}
            </td>
            <td class="indexes-cell" style="white-space: nowrap;">
                {% if repo.has_semantic %}<span class="index-badge semantic" title="Semantic search available">Semantic</span>{% endif %}
                {% if repo.has_fts %}<span class="index-badge fts" title="Full-text search available">FTS</span>{% endif %}
                {% if repo.has_temporal %}<span class="index-badge temporal" title="Git history search available">Temporal</span>{% endif %}
                {% if repo.has_scip %}<span class="index-badge scip" title="SCIP code intelligence available">SCIP</span>{% endif %}
                {% if not repo.has_semantic and not repo.has_fts and not repo.has_temporal and not repo.has_scip %}<span class="no-indexes">None</span>{% endif %}
            </td>
            <td class="repo-url" title="{{ repo.repo_url }}">{{ repo.repo_url | truncate(40) }}</td>
            <td class="status-cell" style="white-space: nowrap;">
                {% if repo.status == 'indexing' %}
                <span class="status-indicator status-indexing" title="Indexing in progress">
                    <span class="spinner"></span> Indexing
                </span>
                {% elif repo.status == 'error' %}
                <span class="status-indicator status-error" title="Error: {{ repo.error_message }}">
                    Error
                </span>
                {% else %}
                <span class="status-indicator status-ready">
                    Ready
                </span>
                {% endif %}
            </td>
            <td class="actions-cell">
                <button class="outline small" onclick="toggleDetails('{{ repo.alias }}')" title="View details">Details</button>
                <button class="small" onclick="showActivateModal('{{ repo.alias }}')" {% if repo.status == 'indexing' %}disabled title="Currently indexing"{% else %}title="Activate for a user"{% endif %}>Activate</button>
                <button class="outline small" onclick="confirmRefresh('{{ repo.alias }}')" {% if repo.status == 'indexing' %}disabled title="Currently indexing"{% else %}title="Re-index repository"{% endif %}>Refresh</button>
                <button class="outline small danger" onclick="confirmDelete('{{ repo.alias }}')" title="Delete repository">Delete</button>
            </td>
        </tr>

        <!-- Details Row (hidden by default) -->
        <tr id="details-{{ repo.alias }}" class="details-row" style="display: none;">
            <td colspan="7">
                <article class="repo-details">
                    <div class="details-grid">
                        <div class="detail-item">
                            <label>Name:</label>
                            <span>{{ repo.alias }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Global Alias:</label>
                            <span>{% if repo.global_alias %}<code>{{ repo.global_alias }}</code> (queryable without activation){% else %}Not globally activated{% endif %}</span>
                        </div>
                        <div class="detail-item">
                            <label>Version:</label>
                            <span>{% if repo.version %}<code>{{ repo.version }}</code>{% else %}Not versioned{% endif %}</span>
                        </div>
                        <div class="detail-item">
                            <label>Last Refresh:</label>
                            <span>{{ repo.last_refresh or 'Never' }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Path/URL:</label>
                            <span>{{ repo.repo_url }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Branch:</label>
                            <span>{{ repo.default_branch or 'main' }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Available Indexes:</label>
                            <span>
                                {% if repo.has_semantic %}Semantic{% endif %}
                                {% if repo.has_semantic and (repo.has_fts or repo.has_temporal or repo.has_scip) %}, {% endif %}
                                {% if repo.has_fts %}FTS{% endif %}
                                {% if repo.has_fts and (repo.has_temporal or repo.has_scip) %}, {% endif %}
                                {% if repo.has_temporal %}Temporal{% endif %}
                                {% if repo.has_temporal and repo.has_scip %}, {% endif %}
                                {% if repo.has_scip %}SCIP{% endif %}
                                {% if not repo.has_semantic and not repo.has_fts and not repo.has_temporal and not repo.has_scip %}None{% endif %}
                            </span>
                        </div>
                        <div class="detail-item">
                            <label>Status:</label>
                            <span>{{ repo.status or 'ready' }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Created:</label>
                            <span>{{ repo.created_at or 'N/A' }}</span>
                        </div>
                        {% if repo.file_count is defined %}
                        <div class="detail-item">
                            <label>Files Indexed:</label>
                            <span>{{ repo.file_count }}</span>
                        </div>
                        {% endif %}
                        {% if repo.chunk_count is defined %}
                        <div class="detail-item">
                            <label>Chunks Indexed:</label>
                            <span>{{ repo.chunk_count }}</span>
                        </div>
                        {% endif %}
                        {% if repo.error_message %}
                        <div class="detail-item error-details">
                            <label>Error:</label>
                            <span class="error-text">{{ repo.error_message }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Indexes Management Section -->
                    <div class="indexes-management">
                        <h4>Indexes Management</h4>
                        <div class="indexes-status-grid">
                            <div class="index-status-item">
                                <label>Semantic + FTS:</label>
                                <span class="index-status" data-index-type="semantic_fts" data-repo-alias="{{ repo.alias }}">
                                    {% if repo.has_semantic and repo.has_fts %}
                                    <span class="status-icon present">✓</span> <span class="status-text">Present</span>
                                    {% else %}
                                    <span class="status-icon not-present">-</span> <span class="status-text">Not Present</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="index-status-item">
                                <label>Temporal (Git History):</label>
                                <span class="index-status" data-index-type="temporal" data-repo-alias="{{ repo.alias }}">
                                    {% if repo.has_temporal %}
                                    <span class="status-icon present">✓</span> <span class="status-text">Present</span>
                                    {% else %}
                                    <span class="status-icon not-present">-</span> <span class="status-text">Not Present</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="index-status-item">
                                <label>SCIP (Code Intelligence):</label>
                                <span class="index-status" data-index-type="scip" data-repo-alias="{{ repo.alias }}">
                                    {% if repo.has_scip %}
                                    <span class="status-icon present">✓</span> <span class="status-text">Present</span>
                                    {% else %}
                                    <span class="status-icon not-present">-</span> <span class="status-text">Not Present</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>

                        <!-- Add Index Button and Form -->
                        <div class="add-index-container" id="add-index-container-{{ repo.alias }}">
                            {% if not (repo.has_semantic and repo.has_fts and repo.has_temporal and repo.has_scip) %}
                            <button class="outline small" onclick="showAddIndexForm('{{ repo.alias }}')">Add Index</button>

                            <div id="add-index-form-{{ repo.alias }}" class="add-index-form" style="display: none;">
                                <label for="index-type-{{ repo.alias }}">Select Index Type:</label>
                                <select id="index-type-{{ repo.alias }}" name="index_type">
                                    {% if not (repo.has_semantic and repo.has_fts) %}
                                    <option value="semantic_fts">Semantic + FTS</option>
                                    {% endif %}
                                    {% if not repo.has_temporal %}
                                    <option value="temporal">Temporal (Git History)</option>
                                    {% endif %}
                                    {% if not repo.has_scip %}
                                    <option value="scip">SCIP (Code Intelligence)</option>
                                    {% endif %}
                                </select>
                                <div class="form-actions">
                                    <button class="small" onclick="submitAddIndex('{{ repo.alias }}')">Submit</button>
                                    <button class="outline small" onclick="hideAddIndexForm('{{ repo.alias }}')">Cancel</button>
                                </div>
                            </div>
                            {% else %}
                            <p class="all-indexes-present"><em>All index types are present</em></p>
                            {% endif %}
                        </div>

                        <!-- Job Progress Container -->
                        <div id="job-progress-{{ repo.alias }}" class="job-progress-container" style="display: none;">
                            <div class="job-progress-header">
                                <span class="job-status-text">Job Status: <span id="job-status-text-{{ repo.alias }}">pending</span></span>
                                <span class="spinner" id="job-spinner-{{ repo.alias }}"></span>
                            </div>
                            <div class="job-progress-details" id="job-progress-details-{{ repo.alias }}"></div>
                        </div>
                    </div>

                    <!-- Temporal Status Section -->
                    {% if repo.temporal_status and repo.global_alias %}
                    <div class="temporal-status-section" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
                        <h4>Temporal Indexing Status</h4>
                        <div class="detail-item">
                            {% if repo.temporal_status.format == 'v2' %}
                            <span class="status-indicator status-active" title="Temporal indexing active with v2 format" style="background-color: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 500;">
                                Active (v2) - {{ repo.temporal_status.file_count }} files indexed
                            </span>
                            {% elif repo.temporal_status.format == 'v1' %}
                            <span class="status-indicator status-error" title="Legacy v1 format detected - non-functional" style="background-color: #f44336; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 500;">
                                Legacy v1 (non-functional) - Re-index required: cidx index --index-commits --reconcile
                            </span>
                            {% elif repo.temporal_status.format == 'error' %}
                            <span class="status-indicator status-error" title="{{ repo.temporal_status.message }}" style="background-color: #f44336; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 500;">
                                Error: {{ repo.temporal_status.message }}
                            </span>
                            {% else %}
                            <span style="color: #888; padding: 4px 8px;" title="Git history not indexed">
                                Not enabled (git history not indexed)
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </article>
            </td>
        </tr>

        <!-- Delete Form (hidden) -->
        <form id="delete-form-{{ repo.alias }}" method="post" action="/admin/golden-repos/{{ repo.alias }}/delete" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        </form>

        <!-- Refresh Form (hidden) -->
        <form id="refresh-form-{{ repo.alias }}" method="post" action="/admin/golden-repos/{{ repo.alias }}/refresh" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        </form>
        {% endfor %}
        {% else %}
        <tr>
            <td colspan="7" class="no-data">No golden repositories configured. Click "Add Repository" to add one.</td>
        </tr>
        {% endif %}
    </tbody>
</table>

<style>
.index-badge {
    display: inline-block;
    padding: 2px 6px;
    margin: 1px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}
.index-badge.semantic {
    background-color: #e3f2fd;
    color: #1565c0;
}
.index-badge.fts {
    background-color: #f3e5f5;
    color: #7b1fa2;
}
.index-badge.temporal {
    background-color: #fff3e0;
    color: #e65100;
}
.index-badge.scip {
    background-color: #e8f5e9;
    color: #2e7d32;
}
.no-indexes {
    color: #999;
    font-style: italic;
}
.version-tag {
    font-size: 0.8rem;
    background-color: #f5f5f5;
    padding: 2px 6px;
    border-radius: 4px;
}
.no-version {
    color: #999;
}
.global-alias {
    background-color: #e8f5e9;
    color: #2e7d32;
    padding: 2px 6px;
    border-radius: 4px;
}
.no-global {
    color: #999;
}
</style>
