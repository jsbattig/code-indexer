<!-- Server Settings Section -->
<details open class="config-section" id="section-server">
    <summary>
        <h2>Server Settings</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-server">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Host</td>
                        <td class="config-value">{{ config.server.host }}</td>
                        <td class="config-note">
                            <small class="read-only-note">Requires server restart</small>
                        </td>
                    </tr>
                    <tr>
                        <td class="config-label">Port</td>
                        <td class="config-value">{{ config.server.port }}</td>
                        <td class="config-note">
                            <small class="read-only-note">Requires server restart</small>
                        </td>
                    </tr>
                    <tr>
                        <td class="config-label">Workers</td>
                        <td class="config-value">{{ config.server.workers }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Log Level</td>
                        <td class="config-value">{{ config.server.log_level }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">JWT Expiration (minutes)</td>
                        <td class="config-value">{{ config.server.jwt_expiration_minutes }}</td>
                        <td class="config-note"></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('server')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-server" method="post" action="/admin/config/server" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.server %}
            <div class="validation-error">{{ validation_errors.server }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="server-host">
                    Host
                    <input type="text" id="server-host" name="host" value="{{ config.server.host }}">
                    <small>Server bind address</small>
                </label>
                <label for="server-port">
                    Port
                    <input type="number" id="server-port" name="port" value="{{ config.server.port }}" min="1" max="65535">
                    <small>1-65535</small>
                </label>
                <label for="server-workers">
                    Workers
                    <input type="number" id="server-workers" name="workers" value="{{ config.server.workers }}" min="1" max="64">
                </label>
                <label for="server-log-level">
                    Log Level
                    <select id="server-log-level" name="log_level">
                        <option value="DEBUG" {% if config.server.log_level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                        <option value="INFO" {% if config.server.log_level == 'INFO' %}selected{% endif %}>INFO</option>
                        <option value="WARNING" {% if config.server.log_level == 'WARNING' %}selected{% endif %}>WARNING</option>
                        <option value="ERROR" {% if config.server.log_level == 'ERROR' %}selected{% endif %}>ERROR</option>
                        <option value="CRITICAL" {% if config.server.log_level == 'CRITICAL' %}selected{% endif %}>CRITICAL</option>
                    </select>
                </label>
                <label for="server-jwt-expiration">
                    JWT Expiration (minutes)
                    <input type="number" id="server-jwt-expiration" name="jwt_expiration_minutes" value="{{ config.server.jwt_expiration_minutes }}" min="1">
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('server')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- Cache Settings Section -->
<details class="config-section" id="section-cache">
    <summary>
        <h2>Cache Settings</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-cache">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Index Cache TTL (minutes)</td>
                        <td class="config-value">{{ config.cache.index_cache_ttl_minutes }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Index Cache Cleanup Interval (sec)</td>
                        <td class="config-value">{{ config.cache.index_cache_cleanup_interval }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Index Cache Max Size (MB)</td>
                        <td class="config-value">{{ config.cache.index_cache_max_size_mb or 'Unlimited' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">FTS Cache TTL (minutes)</td>
                        <td class="config-value">{{ config.cache.fts_cache_ttl_minutes }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">FTS Cache Cleanup Interval (sec)</td>
                        <td class="config-value">{{ config.cache.fts_cache_cleanup_interval }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">FTS Cache Max Size (MB)</td>
                        <td class="config-value">{{ config.cache.fts_cache_max_size_mb or 'Unlimited' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">FTS Reload on Access</td>
                        <td class="config-value">{{ 'Yes' if config.cache.fts_cache_reload_on_access else 'No' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Payload Preview Size (chars)</td>
                        <td class="config-value">{{ config.cache.payload_preview_size_chars }}</td>
                        <td class="config-note"><small>Characters shown in search results preview</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Payload Max Fetch Size (chars)</td>
                        <td class="config-value">{{ config.cache.payload_max_fetch_size_chars }}</td>
                        <td class="config-note"><small>Max chars per page when fetching full content</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Payload Cache TTL (seconds)</td>
                        <td class="config-value">{{ config.cache.payload_cache_ttl_seconds }}</td>
                        <td class="config-note"><small>Time-to-live for cached search results</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Payload Cleanup Interval (seconds)</td>
                        <td class="config-value">{{ config.cache.payload_cleanup_interval_seconds }}</td>
                        <td class="config-note"><small>Interval between cache cleanup runs</small></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('cache')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-cache" method="post" action="/admin/config/cache" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.cache %}
            <div class="validation-error">{{ validation_errors.cache }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="cache-index-ttl">
                    Index Cache TTL (minutes)
                    <input type="number" id="cache-index-ttl" name="index_cache_ttl_minutes" value="{{ config.cache.index_cache_ttl_minutes }}" min="1" step="0.1">
                </label>
                <label for="cache-index-cleanup">
                    Index Cache Cleanup Interval (sec)
                    <input type="number" id="cache-index-cleanup" name="index_cache_cleanup_interval" value="{{ config.cache.index_cache_cleanup_interval }}" min="1">
                </label>
                <label for="cache-fts-ttl">
                    FTS Cache TTL (minutes)
                    <input type="number" id="cache-fts-ttl" name="fts_cache_ttl_minutes" value="{{ config.cache.fts_cache_ttl_minutes }}" min="1" step="0.1">
                </label>
                <label for="cache-fts-cleanup">
                    FTS Cache Cleanup Interval (sec)
                    <input type="number" id="cache-fts-cleanup" name="fts_cache_cleanup_interval" value="{{ config.cache.fts_cache_cleanup_interval }}" min="1">
                </label>
                <label for="cache-payload-preview">
                    Payload Preview Size (chars)
                    <input type="number" id="cache-payload-preview" name="payload_preview_size_chars" value="{{ config.cache.payload_preview_size_chars }}" min="100">
                    <small>Characters shown in search results preview</small>
                </label>
                <label for="cache-payload-fetch">
                    Payload Max Fetch Size (chars)
                    <input type="number" id="cache-payload-fetch" name="payload_max_fetch_size_chars" value="{{ config.cache.payload_max_fetch_size_chars }}" min="100">
                    <small>Max chars per page when fetching full content</small>
                </label>
                <label for="cache-payload-ttl">
                    Payload Cache TTL (seconds)
                    <input type="number" id="cache-payload-ttl" name="payload_cache_ttl_seconds" value="{{ config.cache.payload_cache_ttl_seconds }}" min="1">
                    <small>Time-to-live for cached search results</small>
                </label>
                <label for="cache-payload-cleanup">
                    Payload Cleanup Interval (seconds)
                    <input type="number" id="cache-payload-cleanup" name="payload_cleanup_interval_seconds" value="{{ config.cache.payload_cleanup_interval_seconds }}" min="1">
                    <small>Interval between cache cleanup runs</small>
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('cache')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- Reindexing Settings Section -->
<details class="config-section" id="section-reindexing">
    <summary>
        <h2>Reindexing Settings</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-reindexing">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Change Threshold (%)</td>
                        <td class="config-value">{{ config.reindexing.change_percentage_threshold }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Accuracy Threshold</td>
                        <td class="config-value">{{ config.reindexing.accuracy_threshold }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Max Index Age (days)</td>
                        <td class="config-value">{{ config.reindexing.max_index_age_days }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Batch Size</td>
                        <td class="config-value">{{ config.reindexing.batch_size }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Max Analysis Time (sec)</td>
                        <td class="config-value">{{ config.reindexing.max_analysis_time_seconds }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Max Memory Usage (MB)</td>
                        <td class="config-value">{{ config.reindexing.max_memory_usage_mb }}</td>
                        <td class="config-note"></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('reindexing')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-reindexing" method="post" action="/admin/config/reindexing" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.reindexing %}
            <div class="validation-error">{{ validation_errors.reindexing }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="reindex-change">
                    Change Threshold (%)
                    <input type="number" id="reindex-change" name="change_percentage_threshold" value="{{ config.reindexing.change_percentage_threshold }}" min="0" max="100" step="0.1">
                </label>
                <label for="reindex-accuracy">
                    Accuracy Threshold
                    <input type="number" id="reindex-accuracy" name="accuracy_threshold" value="{{ config.reindexing.accuracy_threshold }}" min="0" max="1" step="0.01">
                </label>
                <label for="reindex-age">
                    Max Index Age (days)
                    <input type="number" id="reindex-age" name="max_index_age_days" value="{{ config.reindexing.max_index_age_days }}" min="1">
                </label>
                <label for="reindex-batch">
                    Batch Size
                    <input type="number" id="reindex-batch" name="batch_size" value="{{ config.reindexing.batch_size }}" min="1">
                </label>
                <label for="reindex-time">
                    Max Analysis Time (sec)
                    <input type="number" id="reindex-time" name="max_analysis_time_seconds" value="{{ config.reindexing.max_analysis_time_seconds }}" min="1">
                </label>
                <label for="reindex-memory">
                    Max Memory Usage (MB)
                    <input type="number" id="reindex-memory" name="max_memory_usage_mb" value="{{ config.reindexing.max_memory_usage_mb }}" min="1">
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('reindexing')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- Timeout Settings Section -->
<details class="config-section" id="section-timeouts">
    <summary>
        <h2>Timeout Settings</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-timeouts">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Git Clone Timeout (sec)</td>
                        <td class="config-value">{{ config.timeouts.git_clone_timeout }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Git Pull Timeout (sec)</td>
                        <td class="config-value">{{ config.timeouts.git_pull_timeout }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Git Refresh Timeout (sec)</td>
                        <td class="config-value">{{ config.timeouts.git_refresh_timeout }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">CIDX Index Timeout (sec)</td>
                        <td class="config-value">{{ config.timeouts.cidx_index_timeout }}</td>
                        <td class="config-note"></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('timeouts')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-timeouts" method="post" action="/admin/config/timeouts" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.timeouts %}
            <div class="validation-error">{{ validation_errors.timeouts }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="timeout-clone">
                    Git Clone Timeout (sec)
                    <input type="number" id="timeout-clone" name="git_clone_timeout" value="{{ config.timeouts.git_clone_timeout }}" min="1">
                </label>
                <label for="timeout-pull">
                    Git Pull Timeout (sec)
                    <input type="number" id="timeout-pull" name="git_pull_timeout" value="{{ config.timeouts.git_pull_timeout }}" min="1">
                </label>
                <label for="timeout-refresh">
                    Git Refresh Timeout (sec)
                    <input type="number" id="timeout-refresh" name="git_refresh_timeout" value="{{ config.timeouts.git_refresh_timeout }}" min="1">
                </label>
                <label for="timeout-index">
                    CIDX Index Timeout (sec)
                    <input type="number" id="timeout-index" name="cidx_index_timeout" value="{{ config.timeouts.cidx_index_timeout }}" min="1">
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('timeouts')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- Password Security Settings Section -->
<details class="config-section" id="section-password_security">
    <summary>
        <h2>Password Security</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-password_security">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Minimum Length</td>
                        <td class="config-value">{{ config.password_security.min_length }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Maximum Length</td>
                        <td class="config-value">{{ config.password_security.max_length }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Required Character Classes</td>
                        <td class="config-value">{{ config.password_security.required_char_classes }}</td>
                        <td class="config-note"><small>1-4 (lowercase, uppercase, numbers, symbols)</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Minimum Entropy (bits)</td>
                        <td class="config-value">{{ config.password_security.min_entropy_bits }}</td>
                        <td class="config-note"></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('password_security')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-password_security" method="post" action="/admin/config/password_security" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.password_security %}
            <div class="validation-error">{{ validation_errors.password_security }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="pwd-min-length">
                    Minimum Length
                    <input type="number" id="pwd-min-length" name="min_length" value="{{ config.password_security.min_length }}" min="1">
                </label>
                <label for="pwd-max-length">
                    Maximum Length
                    <input type="number" id="pwd-max-length" name="max_length" value="{{ config.password_security.max_length }}" min="1">
                </label>
                <label for="pwd-char-classes">
                    Required Character Classes
                    <input type="number" id="pwd-char-classes" name="required_char_classes" value="{{ config.password_security.required_char_classes }}" min="1" max="4">
                    <small>1=lowercase, 2=+uppercase, 3=+numbers, 4=+symbols</small>
                </label>
                <label for="pwd-entropy">
                    Minimum Entropy (bits)
                    <input type="number" id="pwd-entropy" name="min_entropy_bits" value="{{ config.password_security.min_entropy_bits }}" min="1">
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('password_security')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- SSO Authentication Settings Section -->
<details class="config-section" id="section-oidc">
    <summary>
        <h2>SSO Authentication</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-oidc">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Enabled</td>
                        <td class="config-value">{{ 'Yes' if config.oidc.enabled else 'No' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Issuer URL</td>
                        <td class="config-value">{{ config.oidc.issuer_url or 'Not configured' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Client ID</td>
                        <td class="config-value">{{ config.oidc.client_id or 'Not configured' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Client Secret</td>
                        <td class="config-value">{{ '********' if config.oidc.client_secret else 'Not configured' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Scopes</td>
                        <td class="config-value">{{ (config.oidc.scopes or []) | join(', ') }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Email Claim</td>
                        <td class="config-value">{{ config.oidc.email_claim }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Username Claim</td>
                        <td class="config-value">{{ config.oidc.username_claim }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Use PKCE</td>
                        <td class="config-value">{{ 'Yes' if config.oidc.use_pkce else 'No' }}</td>
                        <td class="config-note"><small>Recommended for security</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Require Email Verification</td>
                        <td class="config-value">{{ 'Yes' if config.oidc.require_email_verification else 'No' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Enable JIT Provisioning</td>
                        <td class="config-value">{{ 'Yes' if config.oidc.enable_jit_provisioning else 'No' }}</td>
                        <td class="config-note"><small>Auto-create users on first login</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Default Role</td>
                        <td class="config-value">{{ config.oidc.default_role }}</td>
                        <td class="config-note"><small>For JIT-provisioned users</small></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('oidc')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-oidc" method="post" action="/admin/config/oidc" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.oidc %}
            <div class="validation-error">{{ validation_errors.oidc }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="oidc-enabled">
                    Enabled
                    <select id="oidc-enabled" name="enabled">
                        <option value="true" {% if config.oidc.enabled %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.oidc.enabled %}selected{% endif %}>No</option>
                    </select>
                </label>
                <label for="oidc-issuer-url">
                    Issuer URL
                    <input type="text" id="oidc-issuer-url" name="issuer_url" value="{{ config.oidc.issuer_url }}" placeholder="https://accounts.google.com">
                    <small>OIDC provider's issuer URL</small>
                </label>
                <label for="oidc-client-id">
                    Client ID
                    <input type="text" id="oidc-client-id" name="client_id" value="{{ config.oidc.client_id }}">
                </label>
                <label for="oidc-client-secret">
                    Client Secret
                    <input type="password" id="oidc-client-secret" name="client_secret" value="{{ config.oidc.client_secret }}" placeholder="Leave empty to keep current">
                    <small>Leave empty to keep existing secret</small>
                </label>
                <label for="oidc-scopes">
                    Scopes
                    <input type="text" id="oidc-scopes" name="scopes" value="{{ (config.oidc.scopes or []) | join(' ') }}">
                    <small>Space-separated (e.g., "openid profile email")</small>
                </label>
                <label for="oidc-email-claim">
                    Email Claim
                    <input type="text" id="oidc-email-claim" name="email_claim" value="{{ config.oidc.email_claim }}">
                    <small>OIDC claim for user's email (used for auto-linking existing users and JIT user creation)</small>
                </label>
                <label for="oidc-username-claim">
                    Username Claim
                    <input type="text" id="oidc-username-claim" name="username_claim" value="{{ config.oidc.username_claim }}">
                    <small>OIDC claim for username (used ONLY when creating new users via JIT provisioning)</small>
                </label>
                <label for="oidc-use-pkce">
                    Use PKCE
                    <select id="oidc-use-pkce" name="use_pkce">
                        <option value="true" {% if config.oidc.use_pkce %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.oidc.use_pkce %}selected{% endif %}>No</option>
                    </select>
                    <small>Recommended for security</small>
                </label>
                <label for="oidc-require-email-verification">
                    Require Email Verification
                    <select id="oidc-require-email-verification" name="require_email_verification">
                        <option value="true" {% if config.oidc.require_email_verification %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.oidc.require_email_verification %}selected{% endif %}>No</option>
                    </select>
                </label>
                <label for="oidc-enable-jit-provisioning">
                    Enable JIT Provisioning
                    <select id="oidc-enable-jit-provisioning" name="enable_jit_provisioning">
                        <option value="true" {% if config.oidc.enable_jit_provisioning %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.oidc.enable_jit_provisioning %}selected{% endif %}>No</option>
                    </select>
                    <small>Auto-create users on first login</small>
                </label>
                <label for="oidc-default-role">
                    Default Role
                    <select id="oidc-default-role" name="default_role">
                        <option value="normal_user" {% if config.oidc.default_role == 'normal_user' %}selected{% endif %}>Normal User</option>
                        <option value="admin" {% if config.oidc.default_role == 'admin' %}selected{% endif %}>Admin</option>
                    </select>
                    <small>Role assigned to JIT-provisioned users</small>
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('oidc')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- Job Queue Settings Section -->
<details class="config-section" id="section-job_queue">
    <summary>
        <h2>Job Queue Settings</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-job_queue">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Max Concurrent Jobs (System-wide)</td>
                        <td class="config-value">{{ config.job_queue.max_total_concurrent_jobs }}</td>
                        <td class="config-note"><small>Maximum jobs running simultaneously across all users</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Max Concurrent Jobs (Per User)</td>
                        <td class="config-value">{{ config.job_queue.max_concurrent_jobs_per_user }}</td>
                        <td class="config-note"><small>Maximum jobs a single user can run at once</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Average Job Duration (minutes)</td>
                        <td class="config-value">{{ config.job_queue.average_job_duration_minutes }}</td>
                        <td class="config-note"><small>Used for estimating wait times in queue</small></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('job_queue')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-job_queue" method="post" action="/admin/config/job_queue" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.job_queue %}
            <div class="validation-error">{{ validation_errors.job_queue }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="job-queue-max-total">
                    Max Concurrent Jobs (System-wide)
                    <input type="number" id="job-queue-max-total" name="max_total_concurrent_jobs" value="{{ config.job_queue.max_total_concurrent_jobs }}" min="1" max="50">
                    <small>1-50 jobs</small>
                </label>
                <label for="job-queue-max-per-user">
                    Max Concurrent Jobs (Per User)
                    <input type="number" id="job-queue-max-per-user" name="max_concurrent_jobs_per_user" value="{{ config.job_queue.max_concurrent_jobs_per_user }}" min="1" max="10">
                    <small>1-10 jobs per user</small>
                </label>
                <label for="job-queue-avg-duration">
                    Average Job Duration (minutes)
                    <input type="number" id="job-queue-avg-duration" name="average_job_duration_minutes" value="{{ config.job_queue.average_job_duration_minutes }}" min="1" max="120">
                    <small>Used for queue wait time estimates</small>
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('job_queue')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<details class="config-section" id="section-api-keys">
    <summary>
        <h2>CI/CD API Keys</h2>
    </summary>
    <article>
        <!-- GitHub Actions -->
        <h3>GitHub Actions</h3>
        <div id="display-github-token">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Status</td>
                        <td class="config-value">
                            {% if github_token_data %}
                                <span style="color: green;">Configured</span>
                            {% else %}
                                <span style="color: gray;">Not configured</span>
                            {% endif %}
                        </td>
                        <td class="config-note"></td>
                    </tr>
                    {% if github_token_data %}
                    <tr>
                        <td class="config-label">Token</td>
                        <td class="config-value">{{ github_token_data.token[:10] ~ ('*' * 26) }}</td>
                        <td class="config-note"><small>Personal Access Token (classic) or Fine-grained PAT</small></td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('github-token')">
                    {% if github_token_data %}Update{% else %}Configure{% endif %}
                </button>
                {% if github_token_data %}
                <button class="outline small danger"
                        hx-delete="/admin/config/api-keys/github"
                        hx-headers='{"X-CSRF-Token": "{{ csrf_token }}"}'
                        hx-confirm="Are you sure you want to delete the GitHub API key?"
                        hx-swap="outerHTML">Delete</button>
                {% endif %}
            </div>
        </div>
        <!-- Edit Mode for GitHub -->
        <form id="edit-form-github-token" method="post" action="/admin/config/api-keys/github" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.api_keys %}
            <div class="validation-error">{{ validation_errors.api_keys }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="github-token">
                    GitHub Token
                    <input type="text" id="github-token" name="token"
                           placeholder="ghp_..."
                           value="">
                    <small>Personal Access Token (classic) or Fine-grained PAT with workflow permissions</small>
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('github-token')">Cancel</button>
            </div>
        </form>

        <!-- GitLab CI -->
        <h3 style="margin-top: 2rem;">GitLab CI</h3>
        <div id="display-gitlab-token">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Status</td>
                        <td class="config-value">
                            {% if gitlab_token_data %}
                                <span style="color: green;">Configured</span>
                            {% else %}
                                <span style="color: gray;">Not configured</span>
                            {% endif %}
                        </td>
                        <td class="config-note"></td>
                    </tr>
                    {% if gitlab_token_data %}
                    <tr>
                        <td class="config-label">Token</td>
                        <td class="config-value">{{ gitlab_token_data.token[:10] ~ ('*' * 26) }}</td>
                        <td class="config-note"><small>Personal Access Token or Project Access Token</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Instance URL</td>
                        <td class="config-value">{{ gitlab_token_data.base_url or 'https://gitlab.com' }}</td>
                        <td class="config-note"><small>GitLab instance URL (leave default for gitlab.com)</small></td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('gitlab-token')">
                    {% if gitlab_token_data %}Update{% else %}Configure{% endif %}
                </button>
                {% if gitlab_token_data %}
                <button class="outline small danger"
                        hx-delete="/admin/config/api-keys/gitlab"
                        hx-headers='{"X-CSRF-Token": "{{ csrf_token }}"}'
                        hx-confirm="Are you sure you want to delete the GitLab API key?"
                        hx-swap="outerHTML">Delete</button>
                {% endif %}
            </div>
        </div>
        <!-- Edit Mode for GitLab -->
        <form id="edit-form-gitlab-token" method="post" action="/admin/config/api-keys/gitlab" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.api_keys %}
            <div class="validation-error">{{ validation_errors.api_keys }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="gitlab-token">
                    GitLab Token
                    <input type="text" id="gitlab-token" name="token"
                           placeholder="glpat-..."
                           value="">
                    <small>Personal Access Token or Project Access Token with api scope</small>
                </label>
                <label for="gitlab-api-url">
                    GitLab Instance URL
                    <input type="text" id="gitlab-api-url" name="api_url"
                           placeholder="https://gitlab.com"
                           value="{{ gitlab_token_data.base_url if gitlab_token_data else 'https://gitlab.com' }}">
                    <small>Custom GitLab instance URL (defaults to gitlab.com)</small>
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('gitlab-token')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- Telemetry Settings Section (Story #695) -->
<details class="config-section" id="section-telemetry">
    <summary>
        <h2>Telemetry Settings</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-telemetry">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Enabled</td>
                        <td class="config-value">{{ 'Yes' if config.telemetry.enabled else 'No' }}</td>
                        <td class="config-note">
                            <small class="read-only-note">Requires server restart</small>
                        </td>
                    </tr>
                    <tr>
                        <td class="config-label">Collector Endpoint</td>
                        <td class="config-value">{{ config.telemetry.collector_endpoint }}</td>
                        <td class="config-note"><small>OTLP endpoint URL</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Collector Protocol</td>
                        <td class="config-value">{{ config.telemetry.collector_protocol }}</td>
                        <td class="config-note"><small>grpc or http</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Service Name</td>
                        <td class="config-value">{{ config.telemetry.service_name }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Export Traces</td>
                        <td class="config-value">{{ 'Yes' if config.telemetry.export_traces else 'No' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Export Metrics</td>
                        <td class="config-value">{{ 'Yes' if config.telemetry.export_metrics else 'No' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Export Logs</td>
                        <td class="config-value">{{ 'Yes' if config.telemetry.export_logs else 'No' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Machine Metrics Enabled</td>
                        <td class="config-value">{{ 'Yes' if config.telemetry.machine_metrics_enabled else 'No' }}</td>
                        <td class="config-note"><small>CPU, memory, disk metrics</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Machine Metrics Interval (sec)</td>
                        <td class="config-value">{{ config.telemetry.machine_metrics_interval_seconds }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Trace Sample Rate</td>
                        <td class="config-value">{{ config.telemetry.trace_sample_rate }}</td>
                        <td class="config-note"><small>0.0 to 1.0 (1.0 = 100%)</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Deployment Environment</td>
                        <td class="config-value">{{ config.telemetry.deployment_environment }}</td>
                        <td class="config-note"><small>development, staging, production</small></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('telemetry')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-telemetry" method="post" action="/admin/config/telemetry" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.telemetry %}
            <div class="validation-error">{{ validation_errors.telemetry }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="telemetry-enabled">
                    Enabled
                    <select id="telemetry-enabled" name="enabled">
                        <option value="true" {% if config.telemetry.enabled %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.telemetry.enabled %}selected{% endif %}>No</option>
                    </select>
                    <small>Enable OpenTelemetry export (requires restart)</small>
                </label>
                <label for="telemetry-collector-endpoint">
                    Collector Endpoint
                    <input type="text" id="telemetry-collector-endpoint" name="collector_endpoint"
                           value="{{ config.telemetry.collector_endpoint }}"
                           placeholder="http://localhost:4317">
                    <small>OTLP collector endpoint URL</small>
                </label>
                <label for="telemetry-collector-protocol">
                    Collector Protocol
                    <select id="telemetry-collector-protocol" name="collector_protocol">
                        <option value="grpc" {% if config.telemetry.collector_protocol == 'grpc' %}selected{% endif %}>gRPC</option>
                        <option value="http" {% if config.telemetry.collector_protocol == 'http' %}selected{% endif %}>HTTP</option>
                    </select>
                    <small>OTLP transport protocol</small>
                </label>
                <label for="telemetry-service-name">
                    Service Name
                    <input type="text" id="telemetry-service-name" name="service_name"
                           value="{{ config.telemetry.service_name }}">
                    <small>Service name in traces/metrics</small>
                </label>
                <label for="telemetry-export-traces">
                    Export Traces
                    <select id="telemetry-export-traces" name="export_traces">
                        <option value="true" {% if config.telemetry.export_traces %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.telemetry.export_traces %}selected{% endif %}>No</option>
                    </select>
                </label>
                <label for="telemetry-export-metrics">
                    Export Metrics
                    <select id="telemetry-export-metrics" name="export_metrics">
                        <option value="true" {% if config.telemetry.export_metrics %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.telemetry.export_metrics %}selected{% endif %}>No</option>
                    </select>
                </label>
                <label for="telemetry-export-logs">
                    Export Logs
                    <select id="telemetry-export-logs" name="export_logs">
                        <option value="true" {% if config.telemetry.export_logs %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.telemetry.export_logs %}selected{% endif %}>No</option>
                    </select>
                </label>
                <label for="telemetry-machine-metrics-enabled">
                    Machine Metrics Enabled
                    <select id="telemetry-machine-metrics-enabled" name="machine_metrics_enabled">
                        <option value="true" {% if config.telemetry.machine_metrics_enabled %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.telemetry.machine_metrics_enabled %}selected{% endif %}>No</option>
                    </select>
                    <small>Collect CPU, memory, disk metrics</small>
                </label>
                <label for="telemetry-machine-metrics-interval">
                    Machine Metrics Interval (sec)
                    <input type="number" id="telemetry-machine-metrics-interval" name="machine_metrics_interval_seconds"
                           value="{{ config.telemetry.machine_metrics_interval_seconds }}" min="1">
                </label>
                <label for="telemetry-trace-sample-rate">
                    Trace Sample Rate
                    <input type="number" id="telemetry-trace-sample-rate" name="trace_sample_rate"
                           value="{{ config.telemetry.trace_sample_rate }}" min="0" max="1" step="0.01">
                    <small>0.0 to 1.0 (1.0 = sample all requests)</small>
                </label>
                <label for="telemetry-deployment-environment">
                    Deployment Environment
                    <select id="telemetry-deployment-environment" name="deployment_environment">
                        <option value="development" {% if config.telemetry.deployment_environment == 'development' %}selected{% endif %}>Development</option>
                        <option value="staging" {% if config.telemetry.deployment_environment == 'staging' %}selected{% endif %}>Staging</option>
                        <option value="production" {% if config.telemetry.deployment_environment == 'production' %}selected{% endif %}>Production</option>
                    </select>
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('telemetry')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- Claude Delegation Settings Section (Story #721) -->
<details class="config-section" id="section-claude_delegation">
    <summary>
        <h2>Claude Delegation</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-claude_delegation">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Status</td>
                        <td class="config-value">
                            {% if config.claude_delegation.is_configured %}
                                <span style="color: green;">Configured</span>
                            {% else %}
                                <span style="color: gray;">Not Configured</span>
                            {% endif %}
                        </td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Function Repository Alias</td>
                        <td class="config-value">{{ config.claude_delegation.function_repo_alias }}</td>
                        <td class="config-note"><small>Alias for delegation functions repository</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Claude Server URL</td>
                        <td class="config-value">{{ config.claude_delegation.claude_server_url or 'Not configured' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Username</td>
                        <td class="config-value">{{ config.claude_delegation.claude_server_username or 'Not configured' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Credential Type</td>
                        <td class="config-value">{{ config.claude_delegation.claude_server_credential_type }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Credential</td>
                        <td class="config-value">
                            {% if config.claude_delegation.is_configured %}
                                ********
                            {% else %}
                                Not configured
                            {% endif %}
                        </td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">CIDX Callback URL</td>
                        <td class="config-value">{{ config.claude_delegation.cidx_callback_url or 'Not configured' }}</td>
                        <td class="config-note"><small>URL for job completion callbacks</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Skip SSL Verification</td>
                        <td class="config-value">{{ 'Yes' if config.claude_delegation.skip_ssl_verify else 'No' }}</td>
                        <td class="config-note"><small>Allow self-signed certificates (E2E testing only)</small></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('claude_delegation')">
                    {% if config.claude_delegation.is_configured %}Update{% else %}Configure{% endif %}
                </button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-claude_delegation" method="post" action="/config/claude_delegation" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.claude_delegation %}
            <div class="validation-error">{{ validation_errors.claude_delegation }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="delegation-function-repo-alias">
                    Function Repository Alias
                    <input type="text" id="delegation-function-repo-alias" name="function_repo_alias"
                           value="{{ config.claude_delegation.function_repo_alias }}"
                           placeholder="claude-delegation-functions-global">
                    <small>Alias for the repository containing delegation function definitions</small>
                </label>
                <label for="delegation-server-url">
                    Claude Server URL
                    <input type="text" id="delegation-server-url" name="claude_server_url"
                           value="{{ config.claude_delegation.claude_server_url }}"
                           placeholder="https://claude-server.example.com">
                    <small>URL of the Claude Server for delegation</small>
                </label>
                <label for="delegation-username">
                    Username
                    <input type="text" id="delegation-username" name="claude_server_username"
                           value="{{ config.claude_delegation.claude_server_username }}"
                           placeholder="username">
                    <small>Username for Claude Server authentication</small>
                </label>
                <label for="delegation-credential-type">
                    Credential Type
                    <select id="delegation-credential-type" name="claude_server_credential_type">
                        <option value="password" {% if config.claude_delegation.claude_server_credential_type == 'password' %}selected{% endif %}>Password</option>
                        <option value="api_key" {% if config.claude_delegation.claude_server_credential_type == 'api_key' %}selected{% endif %}>API Key</option>
                    </select>
                </label>
                <label for="delegation-credential">
                    Credential
                    <input type="password" id="delegation-credential" name="claude_server_credential"
                           placeholder="{% if config.claude_delegation.is_configured %}Leave empty to keep current{% else %}Enter password or API key{% endif %}">
                    <small>{% if config.claude_delegation.is_configured %}Leave empty to keep existing credential{% else %}Password or API key for authentication{% endif %}</small>
                </label>
                <label for="delegation-cidx-callback-url">
                    CIDX Callback URL
                    <input type="text" id="delegation-cidx-callback-url" name="cidx_callback_url"
                           value="{{ config.claude_delegation.cidx_callback_url }}"
                           placeholder="http://192.168.60.20:8000">
                    <small>URL that Claude Server will use to POST job completion callbacks</small>
                </label>
                <label for="delegation-skip-ssl-verify">
                    Skip SSL Verification
                    <select id="delegation-skip-ssl-verify" name="skip_ssl_verify">
                        <option value="false" {% if not config.claude_delegation.skip_ssl_verify %}selected{% endif %}>No</option>
                        <option value="true" {% if config.claude_delegation.skip_ssl_verify %}selected{% endif %}>Yes</option>
                    </select>
                    <small>WARNING: Only enable for testing with self-signed certificates</small>
                </label>
            </div>
            <p><small><strong>Note:</strong> Connectivity will be validated before saving. Configuration will only be saved if connection to Claude Server is successful.</small></p>
            <div class="form-actions">
                <button type="submit" class="primary">Save and Test Connection</button>
                <button type="button" class="secondary" onclick="cancelEdit('claude_delegation')">Cancel</button>
            </div>
        </form>
    </article>
</details>
