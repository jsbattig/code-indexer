<!-- Server Settings Section -->
<details open class="config-section" id="section-server">
    <summary>
        <h2>Server Settings</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-server">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Host</td>
                        <td class="config-value">{{ config.server.host }}</td>
                        <td class="config-note">
                            <small class="read-only-note">Requires server restart</small>
                        </td>
                    </tr>
                    <tr>
                        <td class="config-label">Port</td>
                        <td class="config-value">{{ config.server.port }}</td>
                        <td class="config-note">
                            <small class="read-only-note">Requires server restart</small>
                        </td>
                    </tr>
                    <tr>
                        <td class="config-label">Workers</td>
                        <td class="config-value">{{ config.server.workers }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Log Level</td>
                        <td class="config-value">{{ config.server.log_level }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">JWT Expiration (minutes)</td>
                        <td class="config-value">{{ config.server.jwt_expiration_minutes }}</td>
                        <td class="config-note"></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('server')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-server" method="post" action="/admin/config/server" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.server %}
            <div class="validation-error">{{ validation_errors.server }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="server-host">
                    Host
                    <input type="text" id="server-host" name="host" value="{{ config.server.host }}">
                    <small>Server bind address</small>
                </label>
                <label for="server-port">
                    Port
                    <input type="number" id="server-port" name="port" value="{{ config.server.port }}" min="1" max="65535">
                    <small>1-65535</small>
                </label>
                <label for="server-workers">
                    Workers
                    <input type="number" id="server-workers" name="workers" value="{{ config.server.workers }}" min="1" max="64">
                </label>
                <label for="server-log-level">
                    Log Level
                    <select id="server-log-level" name="log_level">
                        <option value="DEBUG" {% if config.server.log_level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                        <option value="INFO" {% if config.server.log_level == 'INFO' %}selected{% endif %}>INFO</option>
                        <option value="WARNING" {% if config.server.log_level == 'WARNING' %}selected{% endif %}>WARNING</option>
                        <option value="ERROR" {% if config.server.log_level == 'ERROR' %}selected{% endif %}>ERROR</option>
                        <option value="CRITICAL" {% if config.server.log_level == 'CRITICAL' %}selected{% endif %}>CRITICAL</option>
                    </select>
                </label>
                <label for="server-jwt-expiration">
                    JWT Expiration (minutes)
                    <input type="number" id="server-jwt-expiration" name="jwt_expiration_minutes" value="{{ config.server.jwt_expiration_minutes }}" min="1">
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('server')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- Cache Settings Section -->
<details class="config-section" id="section-cache">
    <summary>
        <h2>Cache Settings</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-cache">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Index Cache TTL (minutes)</td>
                        <td class="config-value">{{ config.cache.index_cache_ttl_minutes }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Index Cache Cleanup Interval (sec)</td>
                        <td class="config-value">{{ config.cache.index_cache_cleanup_interval }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Index Cache Max Size (MB)</td>
                        <td class="config-value">{{ config.cache.index_cache_max_size_mb or 'Unlimited' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">FTS Cache TTL (minutes)</td>
                        <td class="config-value">{{ config.cache.fts_cache_ttl_minutes }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">FTS Cache Cleanup Interval (sec)</td>
                        <td class="config-value">{{ config.cache.fts_cache_cleanup_interval }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">FTS Cache Max Size (MB)</td>
                        <td class="config-value">{{ config.cache.fts_cache_max_size_mb or 'Unlimited' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">FTS Reload on Access</td>
                        <td class="config-value">{{ 'Yes' if config.cache.fts_cache_reload_on_access else 'No' }}</td>
                        <td class="config-note"></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('cache')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-cache" method="post" action="/admin/config/cache" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.cache %}
            <div class="validation-error">{{ validation_errors.cache }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="cache-index-ttl">
                    Index Cache TTL (minutes)
                    <input type="number" id="cache-index-ttl" name="index_cache_ttl_minutes" value="{{ config.cache.index_cache_ttl_minutes }}" min="1" step="0.1">
                </label>
                <label for="cache-index-cleanup">
                    Index Cache Cleanup Interval (sec)
                    <input type="number" id="cache-index-cleanup" name="index_cache_cleanup_interval" value="{{ config.cache.index_cache_cleanup_interval }}" min="1">
                </label>
                <label for="cache-fts-ttl">
                    FTS Cache TTL (minutes)
                    <input type="number" id="cache-fts-ttl" name="fts_cache_ttl_minutes" value="{{ config.cache.fts_cache_ttl_minutes }}" min="1" step="0.1">
                </label>
                <label for="cache-fts-cleanup">
                    FTS Cache Cleanup Interval (sec)
                    <input type="number" id="cache-fts-cleanup" name="fts_cache_cleanup_interval" value="{{ config.cache.fts_cache_cleanup_interval }}" min="1">
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('cache')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- Reindexing Settings Section -->
<details class="config-section" id="section-reindexing">
    <summary>
        <h2>Reindexing Settings</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-reindexing">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Change Threshold (%)</td>
                        <td class="config-value">{{ config.reindexing.change_percentage_threshold }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Accuracy Threshold</td>
                        <td class="config-value">{{ config.reindexing.accuracy_threshold }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Max Index Age (days)</td>
                        <td class="config-value">{{ config.reindexing.max_index_age_days }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Batch Size</td>
                        <td class="config-value">{{ config.reindexing.batch_size }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Max Analysis Time (sec)</td>
                        <td class="config-value">{{ config.reindexing.max_analysis_time_seconds }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Max Memory Usage (MB)</td>
                        <td class="config-value">{{ config.reindexing.max_memory_usage_mb }}</td>
                        <td class="config-note"></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('reindexing')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-reindexing" method="post" action="/admin/config/reindexing" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.reindexing %}
            <div class="validation-error">{{ validation_errors.reindexing }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="reindex-change">
                    Change Threshold (%)
                    <input type="number" id="reindex-change" name="change_percentage_threshold" value="{{ config.reindexing.change_percentage_threshold }}" min="0" max="100" step="0.1">
                </label>
                <label for="reindex-accuracy">
                    Accuracy Threshold
                    <input type="number" id="reindex-accuracy" name="accuracy_threshold" value="{{ config.reindexing.accuracy_threshold }}" min="0" max="1" step="0.01">
                </label>
                <label for="reindex-age">
                    Max Index Age (days)
                    <input type="number" id="reindex-age" name="max_index_age_days" value="{{ config.reindexing.max_index_age_days }}" min="1">
                </label>
                <label for="reindex-batch">
                    Batch Size
                    <input type="number" id="reindex-batch" name="batch_size" value="{{ config.reindexing.batch_size }}" min="1">
                </label>
                <label for="reindex-time">
                    Max Analysis Time (sec)
                    <input type="number" id="reindex-time" name="max_analysis_time_seconds" value="{{ config.reindexing.max_analysis_time_seconds }}" min="1">
                </label>
                <label for="reindex-memory">
                    Max Memory Usage (MB)
                    <input type="number" id="reindex-memory" name="max_memory_usage_mb" value="{{ config.reindexing.max_memory_usage_mb }}" min="1">
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('reindexing')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- Timeout Settings Section -->
<details class="config-section" id="section-timeouts">
    <summary>
        <h2>Timeout Settings</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-timeouts">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Git Clone Timeout (sec)</td>
                        <td class="config-value">{{ config.timeouts.git_clone_timeout }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Git Pull Timeout (sec)</td>
                        <td class="config-value">{{ config.timeouts.git_pull_timeout }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Git Refresh Timeout (sec)</td>
                        <td class="config-value">{{ config.timeouts.git_refresh_timeout }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">CIDX Index Timeout (sec)</td>
                        <td class="config-value">{{ config.timeouts.cidx_index_timeout }}</td>
                        <td class="config-note"></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('timeouts')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-timeouts" method="post" action="/admin/config/timeouts" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.timeouts %}
            <div class="validation-error">{{ validation_errors.timeouts }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="timeout-clone">
                    Git Clone Timeout (sec)
                    <input type="number" id="timeout-clone" name="git_clone_timeout" value="{{ config.timeouts.git_clone_timeout }}" min="1">
                </label>
                <label for="timeout-pull">
                    Git Pull Timeout (sec)
                    <input type="number" id="timeout-pull" name="git_pull_timeout" value="{{ config.timeouts.git_pull_timeout }}" min="1">
                </label>
                <label for="timeout-refresh">
                    Git Refresh Timeout (sec)
                    <input type="number" id="timeout-refresh" name="git_refresh_timeout" value="{{ config.timeouts.git_refresh_timeout }}" min="1">
                </label>
                <label for="timeout-index">
                    CIDX Index Timeout (sec)
                    <input type="number" id="timeout-index" name="cidx_index_timeout" value="{{ config.timeouts.cidx_index_timeout }}" min="1">
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('timeouts')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- Password Security Settings Section -->
<details class="config-section" id="section-password_security">
    <summary>
        <h2>Password Security</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-password_security">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Minimum Length</td>
                        <td class="config-value">{{ config.password_security.min_length }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Maximum Length</td>
                        <td class="config-value">{{ config.password_security.max_length }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Required Character Classes</td>
                        <td class="config-value">{{ config.password_security.required_char_classes }}</td>
                        <td class="config-note"><small>1-4 (lowercase, uppercase, numbers, symbols)</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Minimum Entropy (bits)</td>
                        <td class="config-value">{{ config.password_security.min_entropy_bits }}</td>
                        <td class="config-note"></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('password_security')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-password_security" method="post" action="/admin/config/password_security" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.password_security %}
            <div class="validation-error">{{ validation_errors.password_security }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="pwd-min-length">
                    Minimum Length
                    <input type="number" id="pwd-min-length" name="min_length" value="{{ config.password_security.min_length }}" min="1">
                </label>
                <label for="pwd-max-length">
                    Maximum Length
                    <input type="number" id="pwd-max-length" name="max_length" value="{{ config.password_security.max_length }}" min="1">
                </label>
                <label for="pwd-char-classes">
                    Required Character Classes
                    <input type="number" id="pwd-char-classes" name="required_char_classes" value="{{ config.password_security.required_char_classes }}" min="1" max="4">
                    <small>1=lowercase, 2=+uppercase, 3=+numbers, 4=+symbols</small>
                </label>
                <label for="pwd-entropy">
                    Minimum Entropy (bits)
                    <input type="number" id="pwd-entropy" name="min_entropy_bits" value="{{ config.password_security.min_entropy_bits }}" min="1">
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('password_security')">Cancel</button>
            </div>
        </form>
    </article>
</details>

<!-- SSO Authentication Settings Section -->
<details class="config-section" id="section-oidc">
    <summary>
        <h2>SSO Authentication</h2>
    </summary>
    <article>
        <!-- Display Mode -->
        <div id="display-oidc">
            <table class="config-table">
                <tbody>
                    <tr>
                        <td class="config-label">Enabled</td>
                        <td class="config-value">{{ 'Yes' if config.oidc.enabled else 'No' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Issuer URL</td>
                        <td class="config-value">{{ config.oidc.issuer_url or 'Not configured' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Client ID</td>
                        <td class="config-value">{{ config.oidc.client_id or 'Not configured' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Client Secret</td>
                        <td class="config-value">{{ '********' if config.oidc.client_secret else 'Not configured' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Scopes</td>
                        <td class="config-value">{{ config.oidc.scopes | join(', ') }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Email Claim</td>
                        <td class="config-value">{{ config.oidc.email_claim }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Username Claim</td>
                        <td class="config-value">{{ config.oidc.username_claim }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Use PKCE</td>
                        <td class="config-value">{{ 'Yes' if config.oidc.use_pkce else 'No' }}</td>
                        <td class="config-note"><small>Recommended for security</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Require Email Verification</td>
                        <td class="config-value">{{ 'Yes' if config.oidc.require_email_verification else 'No' }}</td>
                        <td class="config-note"></td>
                    </tr>
                    <tr>
                        <td class="config-label">Enable JIT Provisioning</td>
                        <td class="config-value">{{ 'Yes' if config.oidc.enable_jit_provisioning else 'No' }}</td>
                        <td class="config-note"><small>Auto-create users on first login</small></td>
                    </tr>
                    <tr>
                        <td class="config-label">Default Role</td>
                        <td class="config-value">{{ config.oidc.default_role }}</td>
                        <td class="config-note"><small>For JIT-provisioned users</small></td>
                    </tr>
                </tbody>
            </table>
            <div class="section-actions">
                <button class="outline small" onclick="toggleEditMode('oidc')">Edit</button>
            </div>
        </div>
        <!-- Edit Mode -->
        <form id="edit-form-oidc" method="post" action="/admin/config/oidc" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% if validation_errors.oidc %}
            <div class="validation-error">{{ validation_errors.oidc }}</div>
            {% endif %}
            <div class="form-grid">
                <label for="oidc-enabled">
                    Enabled
                    <select id="oidc-enabled" name="enabled">
                        <option value="true" {% if config.oidc.enabled %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.oidc.enabled %}selected{% endif %}>No</option>
                    </select>
                </label>
                <label for="oidc-issuer-url">
                    Issuer URL
                    <input type="text" id="oidc-issuer-url" name="issuer_url" value="{{ config.oidc.issuer_url }}" placeholder="https://accounts.google.com">
                    <small>OIDC provider's issuer URL</small>
                </label>
                <label for="oidc-client-id">
                    Client ID
                    <input type="text" id="oidc-client-id" name="client_id" value="{{ config.oidc.client_id }}">
                </label>
                <label for="oidc-client-secret">
                    Client Secret
                    <input type="password" id="oidc-client-secret" name="client_secret" value="{{ config.oidc.client_secret }}" placeholder="Leave empty to keep current">
                    <small>Leave empty to keep existing secret</small>
                </label>
                <label for="oidc-scopes">
                    Scopes
                    <input type="text" id="oidc-scopes" name="scopes" value="{{ config.oidc.scopes | join(' ') }}">
                    <small>Space-separated (e.g., "openid profile email")</small>
                </label>
                <label for="oidc-email-claim">
                    Email Claim
                    <input type="text" id="oidc-email-claim" name="email_claim" value="{{ config.oidc.email_claim }}">
                    <small>OIDC claim for user's email (used for auto-linking existing users and JIT user creation)</small>
                </label>
                <label for="oidc-username-claim">
                    Username Claim
                    <input type="text" id="oidc-username-claim" name="username_claim" value="{{ config.oidc.username_claim }}">
                    <small>OIDC claim for username (used ONLY when creating new users via JIT provisioning)</small>
                </label>
                <label for="oidc-use-pkce">
                    Use PKCE
                    <select id="oidc-use-pkce" name="use_pkce">
                        <option value="true" {% if config.oidc.use_pkce %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.oidc.use_pkce %}selected{% endif %}>No</option>
                    </select>
                    <small>Recommended for security</small>
                </label>
                <label for="oidc-require-email-verification">
                    Require Email Verification
                    <select id="oidc-require-email-verification" name="require_email_verification">
                        <option value="true" {% if config.oidc.require_email_verification %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.oidc.require_email_verification %}selected{% endif %}>No</option>
                    </select>
                </label>
                <label for="oidc-enable-jit-provisioning">
                    Enable JIT Provisioning
                    <select id="oidc-enable-jit-provisioning" name="enable_jit_provisioning">
                        <option value="true" {% if config.oidc.enable_jit_provisioning %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not config.oidc.enable_jit_provisioning %}selected{% endif %}>No</option>
                    </select>
                    <small>Auto-create users on first login</small>
                </label>
                <label for="oidc-default-role">
                    Default Role
                    <select id="oidc-default-role" name="default_role">
                        <option value="normal_user" {% if config.oidc.default_role == 'normal_user' %}selected{% endif %}>Normal User</option>
                        <option value="admin" {% if config.oidc.default_role == 'admin' %}selected{% endif %}>Admin</option>
                    </select>
                    <small>Role assigned to JIT-provisioned users</small>
                </label>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Save</button>
                <button type="button" class="secondary" onclick="cancelEdit('oidc')">Cancel</button>
            </div>
        </form>
    </article>
</details>
