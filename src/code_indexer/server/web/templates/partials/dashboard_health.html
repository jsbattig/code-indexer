<h2>System Health</h2>

<div class="health-grid">
    {% if health %}
    <!-- Overall Status -->
    <article class="health-card overall-status">
        <header>
            <h3>Server Status</h3>
        </header>
        <div class="status-content">
            <span class="status-indicator status-{{ health.status.value }}"></span>
            <span class="status-text">{{ health.status.value | capitalize }}</span>
        </div>
        <footer>
            <small>Last checked: {{ health.timestamp.strftime('%Y-%m-%d %H:%M:%S') if health.timestamp else 'N/A' }}</small>
        </footer>
    </article>

    <!-- Database Status -->
    <article class="health-card">
        <header>
            <h3>Database</h3>
        </header>
        <div class="status-content">
            {% set db_status = health.services.get('database') %}
            {% if db_status %}
            <span class="status-indicator status-{{ db_status.status.value }}"></span>
            <span class="status-text">{{ db_status.status.value | capitalize }}</span>
            {% if db_status.response_time_ms %}
            <small class="response-time">{{ db_status.response_time_ms }}ms</small>
            {% endif %}
            {% else %}
            <span class="status-indicator status-unhealthy"></span>
            <span class="status-text">Unknown</span>
            {% endif %}
        </div>
        {% if db_status and db_status.error_message %}
        <footer>
            <small class="error-text">{{ db_status.error_message }}</small>
        </footer>
        {% endif %}
    </article>

    <!-- Vector Store Status -->
    <article class="health-card">
        <header>
            <h3>Vector Stores</h3>
        </header>
        <div class="status-content">
            {% set vs_status = health.services.get('vector_store') %}
            {% if vs_status %}
            <span class="status-indicator status-{{ vs_status.status.value }}"></span>
            <span class="status-text">{{ vs_status.status.value | capitalize }}</span>
            {% if vs_status.response_time_ms %}
            <small class="response-time">{{ vs_status.response_time_ms }}ms</small>
            {% endif %}
            {% else %}
            <span class="status-indicator status-unhealthy"></span>
            <span class="status-text">Unknown</span>
            {% endif %}
        </div>
        {% if vs_status and vs_status.metadata %}
        <footer>
            <small>
                Golden: {{ vs_status.metadata.get('golden_repos', 0) }} |
                Activated: {{ vs_status.metadata.get('activated_repos', 0) }}
            </small>
        </footer>
        {% endif %}
        {% if vs_status and vs_status.error_message %}
        <footer>
            <small class="error-text">{{ vs_status.error_message }}</small>
        </footer>
        {% endif %}
    </article>

    <!-- Storage Status (Disk only) -->
    <article class="health-card">
        <header>
            <h3>Disk Storage</h3>
        </header>
        <div class="status-content">
            {% set storage_status = health.services.get('storage') %}
            {% if storage_status %}
            <span class="status-indicator status-{{ storage_status.status.value }}"></span>
            <span class="status-text">{{ storage_status.status.value | capitalize }}</span>
            {% else %}
            <span class="status-indicator status-unhealthy"></span>
            <span class="status-text">Unknown</span>
            {% endif %}
        </div>
        {% if health.system %}
        <footer>
            <small>{{ "%.1f"|format(health.system.disk_free_space_gb) if health.system.disk_free_space_gb else 'N/A' }}GB free</small>
        </footer>
        {% endif %}
    </article>

    <!-- System Resources (CPU/RAM) -->
    <article class="health-card">
        <header>
            <h3>System Resources</h3>
        </header>
        {% if health.system %}
        <div class="system-metrics">
            <div class="metric">
                <span class="metric-label">CPU</span>
                <span class="metric-value">{{ "%.1f"|format(health.system.cpu_usage_percent) }}%</span>
                <div class="metric-bar">
                    <div class="metric-fill {% if health.system.cpu_usage_percent > 80 %}high{% elif health.system.cpu_usage_percent > 60 %}medium{% endif %}"
                         style="width: {{ health.system.cpu_usage_percent }}%"></div>
                </div>
            </div>
            <div class="metric">
                <span class="metric-label">Memory</span>
                <span class="metric-value">{{ "%.1f"|format(health.system.memory_usage_percent) }}%</span>
                <div class="metric-bar">
                    <div class="metric-fill {% if health.system.memory_usage_percent > 80 %}high{% elif health.system.memory_usage_percent > 60 %}medium{% endif %}"
                         style="width: {{ health.system.memory_usage_percent }}%"></div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="status-content">
            <span class="status-indicator status-unhealthy"></span>
            <span class="status-text">Unknown</span>
        </div>
        {% endif %}
    </article>
    {% else %}
    <article class="health-card">
        <header>
            <h3>Status</h3>
        </header>
        <div class="status-content">
            <span class="status-indicator status-unhealthy"></span>
            <span class="status-text">Unable to fetch health data</span>
        </div>
    </article>
    {% endif %}
</div>
