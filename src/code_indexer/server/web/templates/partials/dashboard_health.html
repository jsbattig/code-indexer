<h2>System Health</h2>

<div class="health-grid">
    {% if health %}
    <!-- Overall Status -->
    <article class="health-card overall-status">
        <header>
            <h3>Server Status</h3>
        </header>
        <div class="status-content">
            <span class="status-indicator status-{{ health.status.value }}"></span>
            <span class="status-text">{{ health.status.value | capitalize }}</span>
        </div>
        <footer>
            <small>Last checked: {{ health.timestamp.strftime('%Y-%m-%d %H:%M:%S') if health.timestamp else 'N/A' }}</small>
        </footer>
    </article>

    <!-- Database Health Honeycomb (Story #712 AC1-AC4) -->
    <article class="health-card database-health-card">
        <header>
            <h3>Database Health</h3>
        </header>
        <div class="honeycomb-container">
            {% if database_health %}
            <svg class="honeycomb-svg" viewBox="0 0 280 160" preserveAspectRatio="xMidYMid meet">
                <!-- Honeycomb layout: 2 rows of 4 hexagons -->
                {% for i, db in enumerate(database_health) %}
                {% set row = i // 4 %}
                {% set col = i % 4 %}
                {% set x = 35 + col * 55 %}
                {% set y = 40 + row * 65 %}
                {% set status_class = 'healthy' if db.status.value == 'healthy' else ('warning' if db.status.value == 'warning' else 'error') %}
                <g class="hexagon-group" transform="translate({{ x }}, {{ y }})">
                    <polygon class="hexagon hex-{{ status_class }}"
                             points="25,0 50,15 50,45 25,60 0,45 0,15"
                             data-tooltip="{{ db.get_tooltip() }}">
                        <title>{{ db.get_tooltip() }}</title>
                    </polygon>
                    <text class="hex-label" x="25" y="35" text-anchor="middle">
                        {{ db.display_name[:6] }}
                    </text>
                </g>
                {% endfor %}
            </svg>
            <div class="honeycomb-legend">
                <span class="legend-item"><span class="legend-dot healthy"></span>Healthy</span>
                <span class="legend-item"><span class="legend-dot warning"></span>Warning</span>
                <span class="legend-item"><span class="legend-dot error"></span>Error</span>
            </div>
            {% else %}
            <div class="status-content">
                <span class="status-indicator status-unhealthy"></span>
                <span class="status-text">Unable to check databases</span>
            </div>
            {% endif %}
        </div>
    </article>

    <!-- Storage Status (Story #712 AC5: Complete disk metrics) -->
    <article class="health-card">
        <header>
            <h3>Disk Storage</h3>
        </header>
        <div class="status-content">
            {% set storage_status = health.services.get('storage') %}
            {% if storage_status %}
            <span class="status-indicator status-{{ storage_status.status.value }}"></span>
            <span class="status-text">{{ storage_status.status.value | capitalize }}</span>
            {% else %}
            <span class="status-indicator status-unhealthy"></span>
            <span class="status-text">Unknown</span>
            {% endif %}
        </div>
        {% if health.system %}
        <div class="disk-metrics">
            <div class="disk-metric free">
                <span class="disk-value">{{ "%.1f"|format(health.system.disk_free_space_gb) }} GB free</span>
                <span class="disk-percent">({{ "%.1f"|format(health.system.disk_free_percent) }}%)</span>
            </div>
            <div class="disk-metric used">
                <span class="disk-value">{{ "%.1f"|format(health.system.disk_used_space_gb) }} GB used</span>
                <span class="disk-percent">({{ "%.1f"|format(health.system.disk_used_percent) }}%)</span>
            </div>
        </div>
        {% endif %}
    </article>

    <!-- System Resources (CPU/RAM) -->
    <article class="health-card">
        <header>
            <h3>System Resources</h3>
        </header>
        {% if health.system %}
        <div class="system-metrics">
            <div class="metric">
                <span class="metric-label">CPU</span>
                <span class="metric-value">{{ "%.1f"|format(health.system.cpu_usage_percent) }}%</span>
                <div class="metric-bar">
                    <div class="metric-fill {% if health.system.cpu_usage_percent > 80 %}high{% elif health.system.cpu_usage_percent > 60 %}medium{% endif %}"
                         style="width: {{ health.system.cpu_usage_percent }}%"></div>
                </div>
            </div>
            <div class="metric">
                <span class="metric-label">Memory</span>
                <span class="metric-value">{{ "%.1f"|format(health.system.memory_usage_percent) }}%</span>
                <div class="metric-bar">
                    <div class="metric-fill {% if health.system.memory_usage_percent > 80 %}high{% elif health.system.memory_usage_percent > 60 %}medium{% endif %}"
                         style="width: {{ health.system.memory_usage_percent }}%"></div>
                </div>
            </div>
            <div class="metric io-metric" style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="metric-label" style="flex: 0 0 75px;">Disk (R/W)</span>
                <span class="metric-value io-value" style="flex: 1; white-space: nowrap;">
                    <span class="io-read" title="Read">{{ "%.1f"|format(health.system.disk_read_kb_s) }}</span>
                    <span class="io-separator">/</span>
                    <span class="io-write" title="Write">{{ "%.1f"|format(health.system.disk_write_kb_s) }} KB/s</span>
                </span>
            </div>
            <div class="metric io-metric" style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="metric-label" style="flex: 0 0 75px;">Net (Rx/Tx)</span>
                <span class="metric-value io-value" style="flex: 1; white-space: nowrap;">
                    <span class="io-rx" title="Receive (Rx)">{{ "%.1f"|format(health.system.net_rx_kb_s) }}</span>
                    <span class="io-separator">/</span>
                    <span class="io-tx" title="Transmit (Tx)">{{ "%.1f"|format(health.system.net_tx_kb_s) }} KB/s</span>
                </span>
            </div>
        </div>
        {% else %}
        <div class="status-content">
            <span class="status-indicator status-unhealthy"></span>
            <span class="status-text">Unknown</span>
        </div>
        {% endif %}
    </article>
    {% else %}
    <article class="health-card">
        <header>
            <h3>Status</h3>
        </header>
        <div class="status-content">
            <span class="status-indicator status-unhealthy"></span>
            <span class="status-text">Unable to fetch health data</span>
        </div>
    </article>
    {% endif %}
</div>
