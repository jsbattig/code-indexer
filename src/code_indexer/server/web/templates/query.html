{% extends "base.html" %}

{% block title %}Query - CIDX Admin{% endblock %}

{% block content %}
<div class="query-header">
    <h1>Query Testing Interface</h1>
</div>

<!-- Success/Error Messages -->
{% if success_message %}
<article class="message-success">
    <p>{{ success_message }}</p>
</article>
{% endif %}

{% if error_message %}
<article class="message-error">
    <p>{{ error_message }}</p>
</article>
{% endif %}

<div class="query-container">
    <!-- Query Form Section -->
    <section class="query-form-section">
        <form id="query-form" method="post" action="/admin/query">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <!-- Search Mode Toggle -->
            <fieldset class="search-mode-fieldset">
                <legend>Search Mode</legend>
                <div class="search-mode-options">
                    <label>
                        <input type="radio" name="search_mode" value="semantic"
                            {% if search_mode == 'semantic' or not search_mode %}checked{% endif %}>
                        <span>Semantic</span>
                    </label>
                    <label>
                        <input type="radio" name="search_mode" value="fts"
                            {% if search_mode == 'fts' %}checked{% endif %}>
                        <span>Full-Text (FTS)</span>
                    </label>
                    <label>
                        <input type="radio" name="search_mode" value="hybrid"
                            {% if search_mode == 'hybrid' %}checked{% endif %}>
                        <span>Hybrid</span>
                    </label>
                    <label>
                        <input type="radio" name="search_mode" value="temporal"
                            {% if search_mode == 'temporal' %}checked{% endif %}>
                        <span>Temporal (Git History)</span>
                    </label>
                </div>
            </fieldset>

            <!-- FTS Search Options (shown only when FTS or Hybrid mode selected) -->
            <fieldset id="fts-options-fieldset" class="fts-options-fieldset" style="{% if search_mode != 'fts' and search_mode != 'hybrid' %}display: none;{% endif %}">
                <legend>Full-Text Search Options</legend>

                <div class="fts-options-row">
                    <label class="checkbox-label">
                        <input type="checkbox" name="case_sensitive" value="true"
                            {% if case_sensitive %}checked{% endif %}>
                        Case sensitive
                    </label>

                    <label class="checkbox-label">
                        <input type="checkbox" name="fuzzy" value="true"
                            {% if fuzzy %}checked{% endif %}>
                        Fuzzy matching
                    </label>

                    <label class="checkbox-label">
                        <input type="checkbox" name="regex" value="true"
                            {% if regex %}checked{% endif %}>
                        Regex pattern
                    </label>
                </div>

                <small class="field-hint">Note: Fuzzy and Regex are mutually exclusive</small>
            </fieldset>

            <!-- Query Text -->
            <label for="query_text">Query Text <span class="required">*</span></label>
            <textarea
                id="query_text"
                name="query_text"
                rows="4"
                placeholder="Enter your search query..."
                required
            >{{ query_text or '' }}</textarea>

            <!-- Repository Selection -->
            <label for="repository">Repository <span class="required">*</span></label>
            <select id="repository" name="repository" required>
                <option value="">Select a repository...</option>
                {% set has_global = repositories | selectattr('is_global', 'true') | list | length > 0 %}
                {% set has_user = repositories | rejectattr('is_global', 'true') | list | length > 0 %}
                {% if has_global %}
                <optgroup label="Global Repositories">
                    {% for repo in repositories %}
                    {% if repo.is_global %}
                    <option value="{{ repo.user_alias }}" {% if selected_repository == repo.user_alias %}selected{% endif %}>
                        {{ repo.user_alias }}
                    </option>
                    {% endif %}
                    {% endfor %}
                </optgroup>
                {% endif %}
                {% if has_user %}
                <optgroup label="User Repositories">
                    {% for repo in repositories %}
                    {% if not repo.is_global %}
                    <option value="{{ repo.user_alias }}" {% if selected_repository == repo.user_alias %}selected{% endif %}>
                        {{ repo.user_alias }} ({{ repo.username }})
                    </option>
                    {% endif %}
                    {% endfor %}
                </optgroup>
                {% endif %}
            </select>

            <!-- Limit -->
            <label for="limit">Result Limit</label>
            <input
                type="number"
                id="limit"
                name="limit"
                min="1"
                max="100"
                value="{{ limit or 10 }}"
                placeholder="10"
            >

            <!-- Temporal Search Options (shown only when temporal mode selected) -->
            <fieldset id="temporal-options-fieldset" class="temporal-options-fieldset" style="{% if search_mode != 'temporal' %}display: none;{% endif %}">
                <legend>Temporal Search Options</legend>

                <label class="checkbox-label">
                    <input type="checkbox" name="time_range_all" value="true"
                        {% if time_range_all %}checked{% endif %}>
                    Search all git history
                </label>

                <label for="time_range">Time Range</label>
                <input type="text" id="time_range" name="time_range"
                    placeholder="YYYY-MM-DD..YYYY-MM-DD"
                    value="{{ time_range or '' }}">
                <small class="field-hint">Format: 2024-01-01..2024-12-31</small>

                <label for="at_commit">At Specific Commit</label>
                <input type="text" id="at_commit" name="at_commit"
                    placeholder="commit hash or ref"
                    value="{{ at_commit or '' }}">

                <label class="checkbox-label">
                    <input type="checkbox" name="include_removed" value="true"
                        {% if include_removed %}checked{% endif %}>
                    Include removed files
                </label>
            </fieldset>

            <!-- Advanced Options (Collapsible) -->
            <details class="advanced-options">
                <summary>Show Advanced Options</summary>
                <div class="advanced-options-content">
                    <!-- Language Filter -->
                    <label for="language">Language</label>
                    <select id="language" name="language">
                        <option value="">All Languages</option>
                        <option value="python" {% if language == 'python' %}selected{% endif %}>Python</option>
                        <option value="javascript" {% if language == 'javascript' %}selected{% endif %}>JavaScript</option>
                        <option value="typescript" {% if language == 'typescript' %}selected{% endif %}>TypeScript</option>
                        <option value="java" {% if language == 'java' %}selected{% endif %}>Java</option>
                        <option value="c" {% if language == 'c' %}selected{% endif %}>C</option>
                        <option value="cpp" {% if language == 'cpp' %}selected{% endif %}>C++</option>
                        <option value="csharp" {% if language == 'csharp' %}selected{% endif %}>C#</option>
                        <option value="go" {% if language == 'go' %}selected{% endif %}>Go</option>
                        <option value="rust" {% if language == 'rust' %}selected{% endif %}>Rust</option>
                        <option value="ruby" {% if language == 'ruby' %}selected{% endif %}>Ruby</option>
                        <option value="php" {% if language == 'php' %}selected{% endif %}>PHP</option>
                        <option value="html" {% if language == 'html' %}selected{% endif %}>HTML</option>
                        <option value="css" {% if language == 'css' %}selected{% endif %}>CSS</option>
                        <option value="sql" {% if language == 'sql' %}selected{% endif %}>SQL</option>
                        <option value="markdown" {% if language == 'markdown' %}selected{% endif %}>Markdown</option>
                    </select>

                    <!-- File Path Pattern -->
                    <label for="path_pattern">File Path Pattern</label>
                    <input
                        type="text"
                        id="path_pattern"
                        name="path_pattern"
                        placeholder="e.g., */tests/*"
                        value="{{ path_pattern or '' }}"
                    >

                    <!-- Minimum Score -->
                    <label for="min_score">Minimum Score (0.0 - 1.0)</label>
                    <input
                        type="number"
                        id="min_score"
                        name="min_score"
                        min="0"
                        max="1"
                        step="0.1"
                        placeholder="0.0"
                        value="{{ min_score or '' }}"
                    >
                </div>
            </details>

            <!-- Submit Button -->
            <div class="form-actions">
                <button type="submit"
                    hx-post="/admin/partials/query-results"
                    hx-target="#query-results"
                    hx-swap="innerHTML"
                    hx-indicator="#search-indicator"
                    hx-include="#query-form"
                >
                    Search
                </button>
                <span id="search-indicator" class="htmx-indicator">Searching...</span>
            </div>
        </form>
    </section>

    <!-- Query History Section -->
    <section class="query-history-section">
        <h3>Recent Queries</h3>
        <div id="query-history">
            {% if query_history %}
            <ul class="history-list">
                {% for item in query_history %}
                <li>
                    <a href="#" onclick="loadHistoryQuery('{{ item.query_text }}', '{{ item.repository }}', '{{ item.search_mode }}'); return false;">
                        <span class="history-query">{{ item.query_text[:50] }}{% if item.query_text|length > 50 %}...{% endif %}</span>
                        <span class="history-mode">[{{ item.search_mode }}]</span>
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="no-history">No previous queries in this session.</p>
            {% endif %}
        </div>
    </section>
</div>

<!-- Results Section -->
<section id="query-results-section">
    <h2>Results</h2>
    <div id="query-results">
        {% include "partials/query_results.html" %}
    </div>
</section>

<script>
// Show/hide temporal and FTS options based on search mode
function updateSearchModeOptions() {
    const temporalFieldset = document.getElementById('temporal-options-fieldset');
    const ftsFieldset = document.getElementById('fts-options-fieldset');
    const selectedMode = document.querySelector('input[name="search_mode"]:checked');

    if (!selectedMode) return;

    // Temporal options: only for temporal mode
    if (temporalFieldset) {
        temporalFieldset.style.display = (selectedMode.value === 'temporal') ? 'block' : 'none';
    }

    // FTS options: for fts or hybrid modes
    if (ftsFieldset) {
        ftsFieldset.style.display = (selectedMode.value === 'fts' || selectedMode.value === 'hybrid') ? 'block' : 'none';
    }
}

// Attach event listeners to search mode radios
document.querySelectorAll('input[name="search_mode"]').forEach(radio => {
    radio.addEventListener('change', updateSearchModeOptions);
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', updateSearchModeOptions);

function loadHistoryQuery(queryText, repository, searchMode) {
    // Fill form with history query
    document.getElementById('query_text').value = queryText;
    document.getElementById('repository').value = repository;

    // Set search mode radio
    const modeRadios = document.querySelectorAll('input[name="search_mode"]');
    modeRadios.forEach(radio => {
        radio.checked = (radio.value === searchMode);
    });

    // Update search mode options visibility after setting search mode
    updateSearchModeOptions();

    // Optionally auto-submit
    // document.getElementById('query-form').submit();
}

// Handle form submission via htmx
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.target.id === 'query-results') {
        // Scroll to results
        document.getElementById('query-results-section').scrollIntoView({ behavior: 'smooth' });
    }
});
</script>
{% endblock %}
