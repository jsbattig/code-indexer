{% extends "user_base.html" %}

{% block title %}MCP Credentials - CIDX{% endblock %}

{% block content %}
<div class="users-header">
    <h1>MCP Credential Management</h1>
    <div class="users-actions">
        <button id="generate-credential-btn" class="primary" onclick="showGenerateModal()">
            Generate New Credential
        </button>
        <button class="outline" hx-get="/user/partials/mcp-credentials-list" hx-target="#mcp-credentials-list-section" hx-swap="innerHTML" hx-indicator="#refresh-indicator">
            Refresh
        </button>
        <span id="refresh-indicator" class="htmx-indicator">Loading...</span>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="message-area">
{% if success_message %}
<article class="message-success">
    <p>{{ success_message }}</p>
</article>
{% endif %}
{% if error_message %}
<article class="message-error">
    <p>{{ error_message }}</p>
</article>
{% endif %}
</div>

<!-- Generate Credential Modal -->
<dialog id="generate-credential-modal">
    <article>
        <header>
            <h2>Generate New MCP Credential</h2>
            <button type="button" class="close-btn" onclick="closeGenerateModal()" aria-label="Close">&times;</button>
        </header>
        <form id="generate-credential-form" onsubmit="generateCredential(event)">
            <label for="credential-name">Credential Name (optional)</label>
            <input type="text" id="credential-name" name="credential_name" placeholder="e.g., Claude Desktop Work, Laptop" autocomplete="off">
            <div class="form-actions">
                <button type="submit" class="primary">Generate Credential</button>
                <button type="button" class="secondary" onclick="closeGenerateModal()">Cancel</button>
            </div>
        </form>
    </article>
</dialog>

<!-- Generated Credential Display Modal -->
<dialog id="credential-display-modal">
    <article>
        <header>
            <h2>New MCP Credential Generated</h2>
        </header>
        <p class="warning-message"><strong>Warning:</strong> Save both values now. The client_secret will not be shown again.</p>

        <div class="credential-display-container">
            <div class="credential-field">
                <label for="generated-client-id"><strong>Client ID:</strong></label>
                <div class="key-display-area">
                    <input type="text" id="generated-client-id" readonly autocomplete="off" style="font-family: monospace;">
                    <button type="button" class="outline" onclick="copyClientId()">Copy</button>
                </div>
                <p id="copy-client-id-status"></p>
            </div>

            <div class="credential-field">
                <label for="generated-client-secret"><strong>Client Secret:</strong></label>
                <div class="key-display-area">
                    <input type="text" id="generated-client-secret" readonly autocomplete="off" data-sensitive="true" style="font-family: monospace;">
                    <button type="button" class="outline" onclick="copyClientSecret()">Copy</button>
                </div>
                <p id="copy-client-secret-status"></p>
            </div>
        </div>

        <footer>
            <button type="button" onclick="closeCredentialDisplay()">Done</button>
        </footer>
    </article>
</dialog>

<!-- Credentials List Section -->
<section id="mcp-credentials-list-section">
    {% include "partials/mcp_credentials_list.html" %}
</section>

<script>
function showGenerateModal() {
    document.getElementById('generate-credential-modal').showModal();
}

function closeGenerateModal() {
    document.getElementById('generate-credential-modal').close();
    document.getElementById('credential-name').value = '';
}

async function generateCredential(event) {
    event.preventDefault();
    const credentialName = document.getElementById('credential-name').value;

    try {
        const response = await fetch('/api/mcp-credentials', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({ name: credentialName || null })
        });

        if (!response.ok) {
            throw new Error('Failed to generate credential');
        }

        const data = await response.json();
        closeGenerateModal();

        // Show the generated credentials
        document.getElementById('generated-client-id').value = data.client_id;
        document.getElementById('generated-client-secret').value = data.client_secret;
        document.getElementById('credential-display-modal').showModal();

        // Refresh the credentials list
        htmx.trigger('#mcp-credentials-list-section', 'htmx:trigger');
        htmx.ajax('GET', '/user/partials/mcp-credentials-list', {target: '#mcp-credentials-list-section', swap: 'innerHTML'});

    } catch (error) {
        showMessage('Failed to generate MCP credential. Please try again.', 'error');
    }
}

function copyClientId() {
    const input = document.getElementById('generated-client-id');
    input.select();
    navigator.clipboard.writeText(input.value).then(() => {
        document.getElementById('copy-client-id-status').textContent = 'Copied!';
        setTimeout(() => {
            document.getElementById('copy-client-id-status').textContent = '';
        }, 2000);
    }).catch(() => {
        document.getElementById('copy-client-id-status').textContent = 'Failed to copy. Please copy manually.';
    });
}

function copyClientSecret() {
    const input = document.getElementById('generated-client-secret');
    input.select();
    navigator.clipboard.writeText(input.value).then(() => {
        document.getElementById('copy-client-secret-status').textContent = 'Copied!';
        setTimeout(() => {
            document.getElementById('copy-client-secret-status').textContent = '';
        }, 2000);
    }).catch(() => {
        document.getElementById('copy-client-secret-status').textContent = 'Failed to copy. Please copy manually.';
    });
}

function closeCredentialDisplay() {
    document.getElementById('generated-client-id').value = '';
    document.getElementById('generated-client-secret').value = '';
    document.getElementById('copy-client-id-status').textContent = '';
    document.getElementById('copy-client-secret-status').textContent = '';
    document.getElementById('credential-display-modal').close();
}

async function deleteCredential(credentialId, credentialName) {
    const displayName = credentialName || credentialId.substring(0, 8) + '...';
    if (!confirm(`Are you sure you want to delete MCP credential "${displayName}"? This action cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch('/api/mcp-credentials/' + credentialId, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Failed to delete credential');
        }

        showMessage('MCP credential deleted successfully.', 'success');
        htmx.ajax('GET', '/user/partials/mcp-credentials-list', {target: '#mcp-credentials-list-section', swap: 'innerHTML'});

    } catch (error) {
        showMessage('Failed to delete MCP credential. Please try again.', 'error');
    }
}

function showMessage(text, type) {
    const messageArea = document.getElementById('message-area');
    const className = type === 'success' ? 'message-success' : 'message-error';
    const article = document.createElement('article');
    article.className = className;
    const p = document.createElement('p');
    p.textContent = text;
    article.appendChild(p);
    messageArea.innerHTML = '';
    messageArea.appendChild(article);
    setTimeout(() => {
        messageArea.innerHTML = '';
    }, 5000);
}

// Clear sensitive data on page unload
window.addEventListener('beforeunload', function() {
    const clientIdInput = document.getElementById('generated-client-id');
    const clientSecretInput = document.getElementById('generated-client-secret');
    if (clientIdInput) clientIdInput.value = '';
    if (clientSecretInput) clientSecretInput.value = '';
});
</script>

<style>
.credential-display-container {
    margin: 1.5rem 0;
}

.credential-field {
    margin-bottom: 1.5rem;
}

.credential-field label {
    display: block;
    margin-bottom: 0.5rem;
}

.key-display-area {
    display: flex;
    gap: 0.5rem;
}

.key-display-area input {
    flex: 1;
}

.warning-message {
    background-color: #fff3cd;
    border: 1px solid #ffc107;
    padding: 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
}
</style>
{% endblock %}
