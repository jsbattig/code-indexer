# CIDX MCP Bridge Setup Guide

Last Updated: 2025-11-26

## Overview

The CIDX MCP Bridge (MCPB) enables Claude Desktop and other MCP clients to query CIDX servers via the Model Context Protocol (MCP). This bridge translates JSON-RPC MCP requests into CIDX server API calls.

## Prerequisites

Required:
- CIDX server v8.0.0 or later running and accessible via HTTPS
- Python 3.9 or later
- Bearer token for authentication (generated by CIDX server admin)
- Unix-like environment (macOS, Linux) or Windows with Python support

Recommended:
- Claude Desktop (for MCP integration)
- HTTPS endpoint with valid SSL certificate (localhost/127.0.0.1 exempt for testing)

## Installation

### From PyPI (Production)

Installation via PyPI:

```bash
python3 -m pip install --break-system-packages code-indexer
```

This installs the `cidx-bridge` command.

Verify installation:

```bash
cidx-bridge --help
```

Expected output:
```
usage: cidx-bridge [-h] [--diagnose] [--config PATH]

MCP Stdio Bridge - Forward JSON-RPC requests to CIDX server

optional arguments:
  -h, --help      show this help message and exit
  --diagnose      Run configuration diagnostics and exit
  --config PATH   Path to configuration file (default: ~/.mcpb/config.json)
```

### From Source (Development)

Clone repository and install in development mode:

```bash
git clone https://github.com/jsbattig/code-indexer.git
cd code-indexer
python3 -m pip install --break-system-packages -e .
```

Verify installation:

```bash
cidx-bridge --help
```

## Configuration

### Configuration Methods

MCPB supports two configuration methods (priority order):

1. Environment variables (highest priority)
2. Configuration file (~/.mcpb/config.json)

### Required Configuration Fields

- `server_url`: CIDX server base URL (must use HTTPS except for localhost/127.0.0.1)
- `bearer_token`: Authentication token (generated by CIDX server admin)

### Optional Configuration Fields

- `timeout`: Request timeout in seconds (default: 30, range: 1-300)
- `log_level`: Logging level (default: info, options: debug, info, warning, error)

### Method 1: Environment Variables

Environment variables override configuration file settings.

Supported variables (priority order):
- Server URL: `CIDX_SERVER_URL` > `MCPB_SERVER_URL`
- Token: `CIDX_TOKEN` > `MCPB_BEARER_TOKEN`
- Timeout: `CIDX_TIMEOUT` > `MCPB_TIMEOUT`
- Log level: `CIDX_LOG_LEVEL` > `MCPB_LOG_LEVEL`

Example (required fields only):

```bash
export CIDX_SERVER_URL="https://cidx.example.com"
export CIDX_TOKEN="your-bearer-token-here"
```

Example (all fields):

```bash
export CIDX_SERVER_URL="https://cidx.example.com"
export CIDX_TOKEN="your-bearer-token-here"
export CIDX_TIMEOUT="60"
export CIDX_LOG_LEVEL="debug"
```

### Method 2: Configuration File

Create `~/.mcpb/config.json`:

```bash
mkdir -p ~/.mcpb
chmod 700 ~/.mcpb
```

Create configuration file (required fields only):

```json
{
  "server_url": "https://cidx.example.com",
  "bearer_token": "your-bearer-token-here"
}
```

Create configuration file (all fields):

```json
{
  "server_url": "https://cidx.example.com",
  "bearer_token": "your-bearer-token-here",
  "timeout": 60,
  "log_level": "debug"
}
```

Set secure permissions:

```bash
chmod 600 ~/.mcpb/config.json
```

MCPB logs a warning if permissions are not 0600 (insecure).

### Configuration Validation

MCPB validates configuration on startup:

- **server_url**: Must use HTTPS (localhost/127.0.0.1 exempt for testing)
- **bearer_token**: Cannot be empty
- **timeout**: Must be 1-300 seconds
- **log_level**: Must be one of: debug, info, warning, error

Validation errors include fix instructions:

```
Missing required field: server_url
  Fix: Set CIDX_SERVER_URL environment variable
  Or: Add 'server_url' to ~/.mcpb/config.json
```

## Verification

### Check Configuration

Run diagnostics to verify configuration:

```bash
cidx-bridge --diagnose
```

Example output (successful configuration):

```
Configuration Diagnostics
==================================================

Environment Variables:
  CIDX_SERVER_URL: https://cidx.example.com
  CIDX_TOKEN: ****abc

Config File (~/.mcpb/config.json):
  (not used)

Effective Configuration:
  bearer_token: ****abc (from environment)
  log_level: info (from default)
  server_url: https://cidx.example.com (from environment)
  timeout: 30 (from default)

Server Connectivity:
  Status: Server reachable

```

Example output (configuration error):

```
Diagnostics failed: Missing required field: server_url
  Fix: Set CIDX_SERVER_URL environment variable
  Or: Add 'server_url' to ~/.mcpb/config.json
```

### Test Basic Query

Test bridge with simple query:

```bash
echo '{"jsonrpc":"2.0","method":"tools/list","params":{},"id":1}' | cidx-bridge
```

Expected response (JSON-RPC format):

```json
{"jsonrpc":"2.0","result":{"tools":[...],"version":"8.1.0"},"id":1}
```

Error response format (authentication failure):

```json
{"jsonrpc":"2.0","error":{"code":-32000,"message":"Authentication failed: 401 ..."},"id":1}
```

## First Query Walkthrough

### Prerequisites

Verify server has indexed repository:

1. SSH to CIDX server
2. Check repository status:

```bash
cidx server list-repos
```

Note the `repository_alias` for your repository (needed for queries).

### Semantic Search Query

Search for authentication-related code:

```bash
echo '{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "search_code",
    "arguments": {
      "query_text": "authentication",
      "limit": 5
    }
  },
  "id": 1
}' | cidx-bridge
```

Response format:

```json
{
  "jsonrpc": "2.0",
  "result": {
    "results": [
      {
        "file_path": "src/auth/login.py",
        "score": 0.892,
        "content": "def authenticate_user(username, password):\n    ...",
        "metadata": {...}
      }
    ]
  },
  "id": 1
}
```

### Language-Filtered Search

Search only in Python files:

```bash
echo '{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "search_code",
    "arguments": {
      "query_text": "database connection",
      "language": "python",
      "limit": 5
    }
  },
  "id": 1
}' | cidx-bridge
```

### Full-Text Search (FTS)

Search for exact function name:

```bash
echo '{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "search_code",
    "arguments": {
      "query_text": "authenticate_user",
      "search_mode": "fts",
      "case_sensitive": true,
      "limit": 5
    }
  },
  "id": 1
}' | cidx-bridge
```

### Regex Pattern Search

Search for test functions:

```bash
echo '{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "search_code",
    "arguments": {
      "query_text": "test_.*",
      "search_mode": "fts",
      "regex": true,
      "limit": 10
    }
  },
  "id": 1
}' | cidx-bridge
```

## Integration with Claude Desktop

### Configure Claude Desktop

Edit Claude Desktop configuration file:

macOS:
```bash
~/Library/Application Support/Claude/claude_desktop_config.json
```

Linux:
```bash
~/.config/Claude/claude_desktop_config.json
```

Add MCP server configuration:

```json
{
  "mcpServers": {
    "cidx": {
      "command": "cidx-bridge",
      "args": [],
      "env": {
        "CIDX_SERVER_URL": "https://cidx.example.com",
        "CIDX_TOKEN": "your-bearer-token-here"
      }
    }
  }
}
```

Restart Claude Desktop for changes to take effect.

### Verify Integration

Open Claude Desktop and check for CIDX tools:

1. Start new conversation
2. Type: "What CIDX tools are available?"
3. Claude should list 22 CIDX MCP tools including search_code

Test semantic search:

```
Search the codebase for authentication implementation
```

Claude will use the `search_code` tool automatically.

## Common Issues

### Connection Refused

Symptom:
```
Connection failed to https://cidx.example.com: Connection refused
```

Causes:
1. CIDX server not running
2. Incorrect server URL
3. Firewall blocking connection

Fix:
1. Verify server is running: `curl https://cidx.example.com/health`
2. Check `CIDX_SERVER_URL` matches actual server address
3. Verify firewall rules allow HTTPS traffic

### Authentication Failed (401)

Symptom:
```
Authentication failed: 401 Unauthorized
```

Causes:
1. Invalid bearer token
2. Expired token
3. Token mismatch

Fix:
1. Verify token in `CIDX_TOKEN` environment variable
2. Request new token from CIDX server admin
3. Run `cidx-bridge --diagnose` to check effective token (masked)

### HTTPS Required

Symptom:
```
server_url must use HTTPS for security. Got: http://...
```

Cause:
Using HTTP URL for non-localhost server

Fix:
Use HTTPS URL: `https://cidx.example.com`

Localhost exception (testing only):
```bash
export CIDX_SERVER_URL="http://localhost:8000"
```

### Timeout Errors

Symptom:
```
Request timed out after 30 seconds: ...
```

Causes:
1. Large query result set
2. Slow server response
3. Network latency

Fix:
Increase timeout:

```bash
export CIDX_TIMEOUT="120"
```

Or in config file:

```json
{
  "timeout": 120
}
```

### Invalid Log Level

Symptom:
```
log_level must be one of ['debug', 'info', 'warning', 'error']. Got: verbose
```

Fix:
Use valid log level:

```bash
export CIDX_LOG_LEVEL="debug"
```

## Security Considerations

### Bearer Token Protection

1. Never commit tokens to version control
2. Use environment variables for tokens in production
3. Set file permissions to 0600 for config files: `chmod 600 ~/.mcpb/config.json`
4. Rotate tokens regularly (coordinate with CIDX server admin)

### HTTPS Requirement

1. MCPB enforces HTTPS for all non-localhost connections
2. Localhost/127.0.0.1 exempt for testing only
3. Use valid SSL certificates in production
4. Self-signed certificates may require additional httpx configuration (not recommended)

### Network Security

1. Use firewall rules to restrict CIDX server access
2. Consider VPN for remote access
3. Use strong authentication tokens (generated by CIDX server)
4. Monitor access logs on CIDX server

## Next Steps

1. See [Query Guide](query-guide.md) for comprehensive query examples
2. See [API Reference](api-reference.md) for complete parameter documentation
3. See [Troubleshooting Guide](troubleshooting.md) for detailed problem resolution

## Version Compatibility

- MCPB version: 8.1.0 (from src/code_indexer/__init__.py:9)
- CIDX server requirement: v8.0.0 or later
- Python requirement: 3.9 or later (from pyproject.toml:14)
- MCP protocol: JSON-RPC 2.0

Last Updated: 2025-11-26
